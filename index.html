<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Rhythm English</title>
<link rel="manifest" href="manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#14141f;--pri:#6366f1;--acc:#f59e0b;--ok:#10b981;--txt:#f1f5f9;--dim:#64748b;--r:16px}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,sans-serif;-webkit-user-select:none;user-select:none;overflow-x:hidden}
.app{display:flex;flex-direction:column;min-height:100%;padding:env(safe-area-inset-top) 16px calc(env(safe-area-inset-bottom) + 80px)}
/* Header ‚Äî sticky */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 0;position:sticky;top:0;background:var(--bg);z-index:10}
.hdr h1{font-size:18px;font-weight:700}
.hdr-right{display:flex;align-items:center;gap:8px}
.badge{background:var(--pri);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.mode-toggle{display:flex;align-items:center;gap:6px}
.mode-toggle label{font-size:11px;color:var(--dim)}
.toggle{position:relative;width:36px;height:20px;background:#1e1e2e;border-radius:10px;cursor:pointer;transition:background .2s;flex-shrink:0}
.toggle.on{background:var(--pri)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:white;border-radius:50%;transition:left .2s}
.toggle.on::after{left:18px}
/* Progress */
.progress-bar{height:3px;background:#1e1e2e;border-radius:2px;margin-bottom:12px;position:sticky;top:46px;z-index:10}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--pri),var(--acc));border-radius:2px;transition:width .3s}
/* Scene card ‚Äî the big visual */
.scene-card{border-radius:16px;padding:24px 20px;text-align:center;margin-bottom:16px;position:relative;overflow:hidden;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.scene-card::after{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%);pointer-events:none}
.scene-icon{font-size:40px;margin-bottom:6px;filter:drop-shadow(0 2px 8px rgba(0,0,0,0.3))}
.scene-title{font-size:24px;font-weight:900;color:white;letter-spacing:2px;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.scene-sub{font-size:13px;color:rgba(255,255,255,.85);margin-top:4px;font-weight:500}
/* Category tag */
.cat{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;text-align:center}
/* Chinese helper ‚Äî always visible in CN mode */
.cn-helper{font-size:14px;color:var(--acc);background:rgba(245,158,11,0.08);padding:10px 14px;border-radius:10px;margin-bottom:14px;text-align:center;border:1px solid rgba(245,158,11,0.15);line-height:1.5}
/* Stress visualization ‚Äî the core visual */
.stress-row{display:flex;gap:4px;justify-content:center;align-items:flex-end;margin-bottom:16px;min-height:70px;flex-wrap:wrap;padding:8px 0}
.stress-word{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:28px}
.stress-dot{border-radius:50%;transition:all .3s}
.stress-dot.big{background:var(--acc);box-shadow:0 0 8px rgba(245,158,11,0.4)}
.stress-dot.small{background:var(--pri);opacity:.4}
.stress-label{font-size:11px;color:var(--dim);line-height:1.2}
.stress-label.loud{color:var(--acc);font-weight:800;font-size:12px}
/* Sentence */
.sentence{font-size:22px;font-weight:700;text-align:center;line-height:1.4;margin-bottom:4px}
.ipa{font-size:12px;color:var(--dim);text-align:center;margin-bottom:16px;font-family:'Courier New',monospace;opacity:.7}
/* Audio buttons */
.audio-row{display:flex;gap:10px;justify-content:center;margin-bottom:18px}
.audio-btn{border:none;color:white;padding:10px 22px;border-radius:24px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;transition:transform .1s;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.audio-btn:active{transform:scale(.93)}
.audio-btn.primary{background:var(--pri)}
.audio-btn.slow{background:var(--ok)}
.audio-btn.playing{animation:audioPulse 1s ease infinite}
@keyframes audioPulse{0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,.4)}50%{box-shadow:0 0 0 8px rgba(99,102,241,0)}}
/* Sections */
.section{margin-bottom:14px}
.section-label{font-size:10px;color:var(--acc);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px;font-weight:700}
.section-text{font-size:14px;line-height:1.6;color:var(--txt)}
.trap{color:#f87171;font-style:italic;font-size:13px;padding:6px 10px;background:rgba(248,113,113,0.06);border-radius:8px;border-left:3px solid #f87171}
.tip{color:var(--ok);font-size:13px;padding:6px 10px;background:rgba(16,185,129,0.06);border-radius:8px;border-left:3px solid var(--ok)}
/* Variants */
.variants{display:flex;flex-direction:column;gap:6px}
.variant{background:#1a1a2e;padding:8px 12px;border-radius:8px;font-size:13px;border-left:3px solid var(--pri);line-height:1.4}
/* Pattern */
.pattern{background:rgba(99,102,241,0.12);color:var(--pri);padding:6px 12px;border-radius:8px;font-size:13px;font-family:'Courier New',monospace;display:inline-block;border:1px solid rgba(99,102,241,0.2)}
/* Chinese reveal */
.cn-reveal{text-align:center;margin-top:12px;padding:12px 0}
.cn-btn{background:none;border:1px dashed var(--dim);color:var(--dim);padding:8px 20px;border-radius:20px;font-size:12px;cursor:pointer;transition:all .2s}
.cn-btn:active{background:var(--dim);color:var(--bg)}
.cn-text{font-size:14px;color:var(--dim);display:none;margin-top:8px}
.cn-text.show{display:block}
/* Nav ‚Äî fixed bottom */
.nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:12px 24px calc(env(safe-area-inset-bottom,8px) + 8px);background:linear-gradient(transparent,var(--bg) 20%);z-index:20}
.nav-btn{background:var(--card);border:none;color:var(--txt);width:48px;height:48px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.nav-btn:active{background:var(--pri);transform:scale(.9)}
.nav-btn:disabled{opacity:.15}
.nav-count{font-size:13px;color:var(--dim)}
/* Card animation */
.card{background:var(--card);border-radius:var(--r);padding:24px 20px;width:100%;max-width:400px;margin:0 auto;transition:transform .25s ease,opacity .25s ease}
.card.slide-l{transform:translateX(-110%);opacity:0}
.card.slide-r{transform:translateX(110%);opacity:0}
/* Streak bar */
.streak-bar{display:flex;align-items:center;gap:8px;background:var(--card);border-radius:10px;padding:10px 14px;margin-bottom:12px}
.streak-fire{font-size:22px}
.streak-num{font-size:18px;font-weight:900;color:var(--acc)}
.streak-label{font-size:11px;color:var(--dim)}
.streak-dots{display:flex;gap:4px;margin-left:auto}
.streak-d{width:8px;height:8px;border-radius:50%;background:#1e1e2e}
.streak-d.done{background:var(--acc)}
.streak-d.today{background:var(--acc);box-shadow:0 0 6px rgba(245,158,11,.5)}
/* Learned button */
.learn-btn{width:100%;border:none;padding:14px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;margin-top:16px;transition:all .2s}
.learn-btn.unlearned{background:#1e1e2e;color:var(--dim)}
.learn-btn.learned{background:rgba(16,185,129,.15);color:var(--ok)}
.learn-btn:active{transform:scale(.97)}
/* Completion summary */
.complete-summary{text-align:center;padding:8px 0;font-size:12px;color:var(--dim)}
.complete-summary b{color:var(--ok)}
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <h1>üéµ Rhythm English</h1>
    <div class="hdr-right">
      <div class="mode-toggle">
        <label>‰∏≠Êñá</label>
        <div class="toggle" id="cnToggle" onclick="toggleCN()"></div>
      </div>
      <div class="badge" id="xp">Day 1</div>
    </div>
  </div>
  <div class="streak-bar" id="streakBar"></div>
  <div class="progress-bar"><div class="progress-fill" id="prog"></div></div>
  <div class="complete-summary" id="completeSummary"></div>
  <div class="card" id="card"></div>
</div>
<div class="nav">
  <button class="nav-btn" id="prev" onclick="go(-1)">‚Üê</button>
  <span class="nav-count" id="count"></span>
  <button class="nav-btn" id="next" onclick="go(1)">‚Üí</button>
</div>
<script type="module">
import{DAY1,SCENES}from'./data/sentences.js';
let idx=parseInt(localStorage.getItem('re-idx')||'0');
let cnMode=localStorage.getItem('re-cn')==='1';
const $=s=>document.querySelector(s);
let audio=null;
let isPlaying=false;

// Streak & progress tracking
function getProgress(){return JSON.parse(localStorage.getItem('re-progress')||'{"learned":[],"streak":0,"lastDate":null,"history":[]}');}
function saveProgress(p){localStorage.setItem('re-progress',JSON.stringify(p));}
function todayStr(){return new Date().toISOString().slice(0,10);}

window.toggleLearned=function(){
  const p=getProgress();
  const sid=DAY1[idx].id;
  const i=p.learned.indexOf(sid);
  if(i>=0)p.learned.splice(i,1);else p.learned.push(sid);
  // Update streak
  const today=todayStr();
  if(p.lastDate!==today){
    if(p.lastDate){
      const d=new Date(p.lastDate);d.setDate(d.getDate()+1);
      if(d.toISOString().slice(0,10)===today)p.streak++;
      else p.streak=1;
    }else p.streak=1;
    p.lastDate=today;
    if(!p.history.includes(today))p.history.push(today);
  }
  saveProgress(p);
  render();
};

function renderStreak(){
  const p=getProgress();
  const streak=p.streak||0;
  const today=todayStr();
  // Last 7 days
  const dots=[];
  for(let i=6;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    const ds=d.toISOString().slice(0,10);
    const done=p.history&&p.history.includes(ds);
    const isToday=ds===today;
    dots.push(`<div class="streak-d${done?' done':''}${isToday?' today':''}"></div>`);
  }
  $('#streakBar').innerHTML=`
    <span class="streak-fire">üî•</span>
    <span class="streak-num">${streak}</span>
    <span class="streak-label">day streak</span>
    <div class="streak-dots">${dots.join('')}</div>`;
  // Completion summary
  const learnedCount=p.learned.length;
  $('#completeSummary').innerHTML=`<b>${learnedCount}</b>/${DAY1.length} sentences learned today`;
}

window.toggleCN=function(){
  cnMode=!cnMode;
  localStorage.setItem('re-cn',cnMode?'1':'0');
  $('#cnToggle').classList.toggle('on',cnMode);
  render();
};

function render(){
  const s=DAY1[idx];
  if(!s)return;
  const sc=SCENES[s.id]||{icon:"üí¨",colors:["#6366f1","#818cf8"],title:"",sub:""};
  $('#cnToggle').classList.toggle('on',cnMode);
  $('#prog').style.width=((idx+1)/DAY1.length*100)+'%';
  $('#count').textContent=`${idx+1} / ${DAY1.length}`;
  $('#prev').disabled=idx===0;
  $('#next').disabled=idx===DAY1.length-1;
  // Stress dots ‚Äî big=stressed, small=unstressed
  const dots=s.words.map((w,i)=>{
    const stressed=s.stress[i]>=0.8;
    const mid=s.stress[i]>=0.4&&s.stress[i]<0.8;
    const size=stressed?36:mid?22:14;
    const cls=stressed?'big':'small';
    const lblCls=stressed?'loud':'';
    return`<div class="stress-word"><div class="stress-dot ${cls}" style="width:${size}px;height:${size}px"></div><span class="stress-label ${lblCls}">${stressed?w.toUpperCase():w}</span></div>`;
  }).join('');
  // CN helper
  const cnHelper=cnMode?`<div class="cn-helper">üí° ${s.cn}</div>`:'';
  // Card
  $('#card').innerHTML=`
    <div class="cat">${s.cat} ¬∑ ${idx+1}/${DAY1.length}</div>
    <div class="scene-card" style="background:linear-gradient(135deg,${sc.colors[0]},${sc.colors[1]})">
      <div class="scene-icon">${sc.icon}</div>
      <div class="scene-title">${sc.title}</div>
      <div class="scene-sub">${sc.sub}</div>
    </div>
    ${cnHelper}
    <div class="stress-row">${dots}</div>
    <div class="sentence">${s.text}</div>
    <div class="ipa">${s.ipa}</div>
    <div class="audio-row">
      <button class="audio-btn primary" id="playBtn" onclick="window.speak()">üîä Listen</button>
      <button class="audio-btn slow" onclick="window.speakSlow()">üê¢ Slow</button>
    </div>
    <div class="section">
      <div class="section-label">What it means</div>
      <div class="section-text">${s.meaning}</div>
    </div>
    <div class="section">
      <div class="section-label">Pattern</div>
      <div class="pattern">${s.pattern}</div>
    </div>
    <div class="section">
      <div class="section-label">Same pattern</div>
      <div class="variants">${s.variants.map(v=>`<div class="variant">${v}</div>`).join('')}</div>
    </div>
    <div class="section">
      <div class="section-label">‚ö° Rhythm tip</div>
      <div class="tip">${s.tip}</div>
    </div>
    <div class="section">
      <div class="section-label">‚ùå Non-native trap</div>
      <div class="trap">${s.trap}</div>
    </div>
    ${!cnMode?`<div class="cn-reveal">
      <button class="cn-btn" onclick="this.nextElementSibling.classList.toggle('show');this.textContent=this.textContent==='Reveal ‰∏≠Êñá'?'Hide ‰∏≠Êñá':'Reveal ‰∏≠Êñá'">Reveal ‰∏≠Êñá</button>
      <div class="cn-text">${s.cn}</div>
    </div>`:''}
    <button class="learn-btn ${getProgress().learned.includes(s.id)?'learned':'unlearned'}" onclick="window.toggleLearned()">
      ${getProgress().learned.includes(s.id)?'‚úÖ Learned!':'Mark as Learned'}
    </button>
  `;
  renderStreak();
  // Scroll to top on card change
  window.scrollTo({top:0,behavior:'smooth'});
  localStorage.setItem('re-idx',idx);
}

function playAudio(rate=1){
  if(audio){audio.pause();audio.currentTime=0;}
  const id=String(DAY1[idx].id).padStart(2,'0');
  audio=new Audio('audio/'+id+'.mp3');
  audio.playbackRate=rate;
  const btn=document.getElementById('playBtn');
  audio.onplay=()=>{if(btn)btn.classList.add('playing');};
  audio.onended=()=>{if(btn)btn.classList.remove('playing');};
  audio.onerror=()=>{
    if(btn)btn.classList.remove('playing');
    const u=new SpeechSynthesisUtterance(DAY1[idx].text);
    u.lang='en-US';u.rate=rate*0.85;
    speechSynthesis.speak(u);
  };
  audio.play().catch(()=>audio.onerror());
}

window.speak=function(){playAudio(1);};
window.speakSlow=function(){playAudio(0.7);};

window.go=function(dir){
  const card=$('#card');
  card.classList.add(dir>0?'slide-l':'slide-r');
  setTimeout(()=>{
    idx=Math.max(0,Math.min(DAY1.length-1,idx+dir));
    card.classList.remove('slide-l','slide-r');
    render();
  },200);
};

// Swipe ‚Äî horizontal only, don't block scroll
let sx=0,sy=0;
document.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;},{passive:true});
document.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-sx;
  const dy=e.changedTouches[0].clientY-sy;
  if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*1.5){dx<0?go(1):go(-1);}
},{passive:true});

// Keyboard nav
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowRight')go(1);
  if(e.key==='ArrowLeft')go(-1);
  if(e.key===' '){e.preventDefault();window.speak();}
});

render();
</script>
</body>
</html>
