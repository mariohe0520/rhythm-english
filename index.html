<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ËäÇÂ•èËã±ËØ≠ Rhythm English</title>
<link rel="manifest" href="manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0c1021;--bg2:#1a1f35;--card:#141929;--pri:#6366f1;--acc:#f0b429;--ok:#34d399;--txt:#f8f4ef;--dim:#94a3b8;--red:#ef4444;--r:16px;--gold:#f0b429;--gold-glow:rgba(240,180,41,.45);--emerald:#34d399;--cream:#f8f4ef}
html,body{height:100%;background:linear-gradient(165deg,var(--bg) 0%,var(--bg2) 100%);color:var(--txt);font-family:-apple-system,system-ui,'Segoe UI',sans-serif;-webkit-user-select:none;user-select:none;overflow-x:hidden}
.app{display:flex;flex-direction:column;min-height:100%;padding:env(safe-area-inset-top) max(16px,env(safe-area-inset-right)) calc(env(safe-area-inset-bottom) + 80px) max(16px,env(safe-area-inset-left))}
/* Header ‚Äî sticky */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 0;padding-top:max(16px,env(safe-area-inset-top,16px));position:sticky;top:0;background:var(--bg);z-index:10}
.hdr h1{font-size:18px;font-weight:700}
.hdr-right{display:flex;align-items:center;gap:8px}
.badge{background:var(--pri);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.mode-toggle{display:flex;align-items:center;gap:6px}
.mode-toggle label{font-size:11px;color:var(--dim)}
.toggle{position:relative;width:36px;height:20px;background:#1e1e2e;border-radius:10px;cursor:pointer;transition:background .2s;flex-shrink:0;border:none;outline:none;-webkit-appearance:none;appearance:none}
.toggle::before{content:'';position:absolute;top:50%;left:50%;width:44px;height:44px;transform:translate(-50%,-50%)}
.toggle.on{background:var(--pri)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:white;border-radius:50%;transition:left .2s}
.toggle.on::after{left:18px}
.toggle:focus-visible{outline:2px solid var(--pri);outline-offset:4px;border-radius:10px}
/* Progress */
.progress-bar{height:3px;background:#1e1e2e;border-radius:2px;margin-bottom:12px;position:sticky;top:calc(46px + env(safe-area-inset-top,0px));z-index:10}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--pri),var(--acc));border-radius:2px;transition:width .3s}
/* Scene card ‚Äî the big visual */
.scene-card{border-radius:16px;padding:24px 20px;text-align:center;margin-bottom:16px;position:relative;overflow:hidden;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.scene-card::after{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%);pointer-events:none}
.scene-icon{font-size:40px;margin-bottom:6px;filter:drop-shadow(0 2px 8px rgba(0,0,0,0.3))}
.scene-title{font-size:24px;font-weight:900;color:white;letter-spacing:2px;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.scene-sub{font-size:13px;color:rgba(255,255,255,.85);margin-top:4px;font-weight:500}
/* Category tag */
.cat{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;text-align:center}
/* Chinese helper ‚Äî always visible in CN mode */
.cn-helper{font-size:14px;color:var(--acc);background:rgba(245,158,11,0.08);padding:10px 14px;border-radius:10px;margin-bottom:14px;text-align:center;border:1px solid rgba(245,158,11,0.15);line-height:1.5;overflow-wrap:break-word}
/* Stress visualization ‚Äî the core visual */
.stress-row{display:flex;gap:4px;justify-content:center;align-items:flex-end;margin-bottom:16px;min-height:70px;flex-wrap:wrap;padding:8px 0}
.stress-word{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:28px}
.stress-dot{border-radius:50%;transition:all .3s}
.stress-dot.big{background:var(--acc);box-shadow:0 0 8px rgba(245,158,11,0.4)}
.stress-dot.small{background:var(--pri);opacity:.4}
.stress-label{font-size:11px;color:var(--dim);line-height:1.2}
.stress-label.loud{color:var(--acc);font-weight:800;font-size:12px}
/* Sentence */
.sentence{font-size:22px;font-weight:700;text-align:center;line-height:1.4;margin-bottom:4px;overflow-wrap:break-word;word-break:break-word}
.ipa{font-size:12px;color:var(--dim);text-align:center;margin-bottom:16px;font-family:'Courier New',monospace}
/* Audio buttons */
.audio-row{display:flex;gap:8px;justify-content:center;margin-bottom:18px;flex-wrap:wrap}
.audio-btn{border:none;color:white;padding:12px 22px;border-radius:24px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;transition:transform .1s;box-shadow:0 2px 8px rgba(0,0,0,.2);min-height:44px}
.audio-btn:active{transform:scale(.93)}
.audio-btn.primary{background:var(--pri)}
.audio-btn.slow{background:var(--ok)}
.audio-btn.playing{animation:audioPulse 1s ease infinite}
@keyframes audioPulse{0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,.4)}50%{box-shadow:0 0 0 8px rgba(99,102,241,0)}}
/* Sections */
.section{margin-bottom:14px}
.section-label{font-size:11px;color:var(--acc);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px;font-weight:700}
.section-text{font-size:14px;line-height:1.6;color:var(--txt)}
.trap{color:#f87171;font-style:italic;font-size:13px;padding:6px 10px;background:rgba(248,113,113,0.06);border-radius:8px;border-left:3px solid #f87171;overflow-wrap:break-word}
.tip{color:var(--ok);font-size:13px;padding:6px 10px;background:rgba(16,185,129,0.06);border-radius:8px;border-left:3px solid var(--ok);overflow-wrap:break-word}
/* Variants */
.variants{display:flex;flex-direction:column;gap:6px}
.variant{background:#1a1a2e;padding:8px 12px;border-radius:8px;font-size:13px;border-left:3px solid var(--pri);line-height:1.4;overflow-wrap:break-word}
/* Pattern */
.pattern{background:rgba(99,102,241,0.12);color:var(--pri);padding:6px 12px;border-radius:8px;font-size:13px;font-family:'Courier New',monospace;display:inline-block;border:1px solid rgba(99,102,241,0.2)}
/* Chinese reveal */
.cn-reveal{text-align:center;margin-top:12px;padding:12px 0}
.cn-btn{background:none;border:1px dashed var(--dim);color:var(--dim);padding:12px 20px;border-radius:20px;font-size:13px;cursor:pointer;transition:all .2s;min-height:44px}
.cn-btn:active{background:var(--dim);color:var(--bg)}
.cn-text{font-size:14px;color:var(--dim);display:none;margin-top:8px}
.cn-text.show{display:block}
/* Nav ‚Äî fixed bottom */
.nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:12px 24px calc(env(safe-area-inset-bottom,8px) + 8px);background:linear-gradient(transparent,var(--bg) 20%);z-index:20}
.nav-btn{background:var(--card);border:none;color:var(--txt);width:48px;height:48px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.nav-btn:focus-visible{outline:2px solid var(--pri);outline-offset:2px}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.nav-btn:active{background:var(--pri);transform:scale(.9)}
.nav-btn:disabled{opacity:.15}
.nav-count{font-size:13px;color:var(--dim)}
/* Card animation */
.card{background:var(--card);border-radius:var(--r);padding:24px 20px;width:100%;max-width:400px;margin:0 auto;transition:transform .25s ease,opacity .25s ease}
.card.slide-l{transform:translateX(-110%);opacity:0}
.card.slide-r{transform:translateX(110%);opacity:0}
/* Streak bar */
.streak-bar{display:flex;align-items:center;gap:8px;background:var(--card);border-radius:10px;padding:10px 14px;margin-bottom:12px}
.streak-fire{font-size:22px}
.streak-num{font-size:18px;font-weight:900;color:var(--acc)}
.streak-label{font-size:11px;color:var(--dim)}
.streak-dots{display:flex;gap:4px;margin-left:auto}
.streak-d{width:8px;height:8px;border-radius:50%;background:#1e1e2e}
.streak-d.done{background:var(--acc)}
.streak-d.today{background:var(--acc);box-shadow:0 0 6px rgba(245,158,11,.5)}
/* Learned button */
.learn-btn{width:100%;border:none;padding:14px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;margin-top:16px;transition:all .2s}
.learn-btn.unlearned{background:#1e1e2e;color:var(--dim)}
.learn-btn.learned{background:rgba(16,185,129,.15);color:var(--ok)}
.learn-btn:active{transform:scale(.97)}
/* Completion summary */
.complete-summary{text-align:center;padding:8px 0;font-size:12px;color:var(--dim)}
.complete-summary b{color:var(--ok)}
/* Quiz mode */
.quiz-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:100;display:none;flex-direction:column;padding:max(20px,env(safe-area-inset-top,20px)) 20px 20px;overflow-y:auto}
.quiz-overlay.active{display:flex}
.quiz-progress{display:flex;gap:3px;margin-bottom:20px}
.quiz-pip{flex:1;height:4px;border-radius:2px;background:#1e1e2e}
.quiz-pip.done{background:var(--ok)}
.quiz-pip.wrong{background:var(--red)}
.quiz-pip.current{background:var(--acc)}
.quiz-q{font-size:18px;font-weight:700;text-align:center;margin:20px 0 12px;line-height:1.4}
.quiz-hint{font-size:13px;color:var(--dim);text-align:center;margin-bottom:20px}
.quiz-opts{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.quiz-opt{padding:16px;border-radius:12px;background:var(--card);border:2px solid transparent;font-size:15px;color:var(--txt);cursor:pointer;text-align:left;transition:all .15s;line-height:1.4;min-height:44px;width:100%;font-family:inherit;-webkit-appearance:none;appearance:none;outline:none;display:block}
.quiz-opt:focus-visible{outline:2px solid var(--pri);outline-offset:2px}
.quiz-opt:active{transform:scale(.97)}
.quiz-opt.selected{border-color:var(--acc);background:rgba(99,102,241,.1)}
.quiz-opt.correct{border-color:var(--ok);background:rgba(16,185,129,.1)}
.quiz-opt.wrong{border-color:var(--red);background:rgba(239,68,68,.1)}
.quiz-feedback{text-align:center;padding:16px;border-radius:12px;margin-bottom:16px;font-size:14px;font-weight:600}
.quiz-feedback.right{background:rgba(16,185,129,.1);color:var(--ok)}
.quiz-feedback.wrong{background:rgba(239,68,68,.1);color:var(--red)}
.quiz-next-btn{width:100%;padding:16px;border-radius:12px;border:none;font-size:16px;font-weight:700;cursor:pointer;background:var(--pri);color:white;margin-top:auto}
.quiz-next-btn:active{transform:scale(.97)}
.quiz-score{text-align:center;margin:40px 0}
.quiz-score-num{font-size:64px;font-weight:900;color:var(--ok)}
.quiz-score-label{font-size:16px;color:var(--dim);margin-top:4px}
.quiz-xp{font-size:24px;font-weight:800;color:var(--acc);margin-top:12px}
/* Quiz trigger button */
.quiz-trigger{width:100%;padding:14px;border-radius:12px;border:2px dashed var(--acc);background:transparent;color:var(--acc);font-size:15px;font-weight:700;cursor:pointer;margin-top:12px;transition:all .2s}
.quiz-trigger:active{background:rgba(99,102,241,.1);transform:scale(.97)}
/* XP display */
.xp-display{display:flex;align-items:center;gap:4px}
.xp-num{font-size:13px;font-weight:800;color:var(--acc)}
/* Rhythm bouncing ball */
.rhythm-ball{position:absolute;width:12px;height:12px;background:var(--acc);border-radius:50%;box-shadow:0 0 12px rgba(245,158,11,.6);transition:left .15s ease-out;z-index:5;pointer-events:none}
.rhythm-ball.big{width:18px;height:18px;background:#f59e0b;box-shadow:0 0 20px rgba(245,158,11,.8)}
@keyframes ballBounce{0%{transform:translateY(0)}40%{transform:translateY(-22px)}100%{transform:translateY(0)}}
@keyframes ballBounceBig{0%{transform:translateY(0) scale(1)}30%{transform:translateY(-36px) scale(1.4)}100%{transform:translateY(0) scale(1)}}
.stress-word.active{transform:scale(1.15);transition:transform .15s}
.stress-word.active .stress-label{color:var(--acc)!important;font-weight:900!important}
.stress-word.active .stress-dot{box-shadow:0 0 14px rgba(245,158,11,.7)!important}
/* Day Switcher */
.day-switcher{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding-bottom:4px;scrollbar-width:none;-ms-overflow-style:none}
.day-switcher::-webkit-scrollbar{display:none}
.day-pill{flex-shrink:0;min-width:72px;padding:12px 10px;border-radius:12px;border:2px solid #1e1e2e;background:var(--card);color:var(--dim);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;transition:all .2s;scroll-snap-align:start}
.day-pill.active{border-color:var(--pri);background:rgba(99,102,241,.15);color:var(--txt)}
.day-pill.locked{opacity:.45;cursor:not-allowed}
.day-pill.locked:active{transform:none}
.day-pill:active{transform:scale(.97)}
.day-pill-label{font-size:13px;font-weight:800;letter-spacing:.5px}
.day-pill-sub{font-size:11px;opacity:.7}
.day-pill-badge{font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;background:#1e1e2e;margin-top:2px}
.day-pill.active .day-pill-badge{background:var(--pri);color:white}
/* Day Overview */
.day-overview{display:flex;justify-content:center;gap:8px;margin-bottom:10px;font-size:11px;color:var(--dim);flex-wrap:wrap}
.day-ov-badge{padding:3px 10px;border-radius:8px;background:var(--card);display:inline-flex;align-items:center;gap:4px}
.day-ov-badge.active{color:var(--pri);font-weight:700;border:1px solid rgba(99,102,241,.3)}
.day-ov-badge.locked{opacity:.5}
/* Recording & Comparison */
.rec-btn{background:var(--card)!important;border:2px solid var(--dim)}
.rec-btn.recording{background:var(--red)!important;border-color:var(--red)!important;animation:recPulse 1s ease infinite}
@keyframes recPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}50%{box-shadow:0 0 0 12px rgba(239,68,68,0)}}
.rec-timer{font-size:11px;color:var(--red);font-weight:700;font-variant-numeric:tabular-nums}
.compare-area{background:var(--card);border-radius:14px;padding:16px;margin-bottom:18px;border:1px solid #1e1e2e}
.compare-label{font-size:11px;color:var(--acc);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;font-weight:700;text-align:center}
.compare-btns{display:flex;gap:10px;justify-content:center;margin-bottom:14px}
.compare-btn{border:none;color:white;padding:10px 18px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;transition:transform .1s;box-shadow:0 2px 6px rgba(0,0,0,.2)}
.compare-btn:active{transform:scale(.93)}
.compare-btn.native{background:var(--pri)}
.compare-btn.user{background:var(--ok)}
.compare-btn.cplaying{animation:audioPulse 1s ease infinite}
.waveform-wrap{display:flex;gap:8px;margin-bottom:14px}
.waveform-box{flex:1;text-align:center}
.waveform-box label{font-size:11px;color:var(--dim);display:block;margin-bottom:4px}
.waveform-canvas{width:100%;height:50px;border-radius:8px;background:#0a0a0f;display:block}
.score-wrap{display:flex;flex-direction:column;align-items:center;margin:12px 0 4px}
.score-ring-container{position:relative;width:80px;height:80px}
.score-ring-svg{transform:rotate(-90deg)}
.score-ring-bg{fill:none;stroke:#1e1e2e;stroke-width:6}
.score-ring-fg{fill:none;stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset .8s ease,stroke .3s}
.score-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:22px;font-weight:900}
.score-label{font-size:11px;color:var(--dim);margin-top:6px}
.score-detail{font-size:11px;color:var(--dim);margin-top:4px;text-align:center}
.rec-history{margin-top:12px;padding-top:12px;border-top:1px solid #1e1e2e}
.rec-history-label{font-size:11px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;text-align:center}
.rec-history-list{display:flex;gap:8px;justify-content:center}
.rec-hist-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:8px 12px;border-radius:10px;background:#0a0a0f;transition:all .15s;min-width:56px}
.rec-hist-item:active{background:#1e1e2e;transform:scale(.95)}
.rec-hist-item.active{border:1px solid var(--ok)}
.rec-hist-score{font-size:14px;font-weight:800}
.rec-hist-time{font-size:9px;color:var(--dim)}
.rec-hist-play{font-size:16px;margin-top:2px}

/* ========== PREMIUM VISUAL OVERHAUL ========== */

/* --- Noise texture on background --- */
body::before{
  content:'';position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;opacity:.035;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-repeat:repeat;background-size:180px
}
body>*{position:relative;z-index:1}

/* --- Header glow & glass --- */
.hdr{
  background:linear-gradient(180deg,var(--bg) 60%,transparent)!important;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  padding-bottom:16px
}
.hdr h1{
  background:linear-gradient(135deg,var(--gold),#fde68a);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;font-size:20px
}

/* --- Streak bar with fire glow --- */
.streak-bar{
  background:rgba(20,25,41,.7);border:1px solid rgba(240,180,41,.12);
  box-shadow:0 0 20px rgba(240,180,41,.08),0 2px 8px rgba(0,0,0,.3);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  border-radius:14px
}
.streak-fire{filter:drop-shadow(0 0 8px rgba(240,180,41,.6)) drop-shadow(0 0 16px rgba(239,68,68,.3))}
.streak-num{text-shadow:0 0 12px var(--gold-glow)}
.streak-d.done{box-shadow:0 0 6px var(--gold-glow)}
.streak-d.today{animation:todayPulse 2s ease infinite}
@keyframes todayPulse{0%,100%{box-shadow:0 0 6px var(--gold-glow)}50%{box-shadow:0 0 14px var(--gold-glow),0 0 24px rgba(240,180,41,.2)}}

/* --- Progress bar glow --- */
.progress-fill{
  background:linear-gradient(90deg,var(--pri),var(--gold));
  box-shadow:0 0 12px rgba(240,180,41,.3)
}

/* --- Scene cards ‚Äî premium depth --- */
.scene-card{
  border-radius:20px;
  box-shadow:0 4px 6px rgba(0,0,0,.2),0 12px 24px rgba(0,0,0,.3),0 24px 48px rgba(0,0,0,.15),inset 0 1px 0 rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.08);
  transition:transform .25s ease,box-shadow .25s ease
}
.scene-card:active{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.3),0 16px 32px rgba(0,0,0,.35),0 32px 56px rgba(0,0,0,.2)}

/* --- Main card ‚Äî glass depth --- */
.card{
  background:rgba(20,25,41,.65)!important;
  backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,.06);
  box-shadow:0 4px 6px rgba(0,0,0,.15),0 12px 24px rgba(0,0,0,.2),0 24px 48px rgba(0,0,0,.1)
}

/* --- Bouncing ball ‚Äî radial gradient + shine --- */
.rhythm-ball{
  background:radial-gradient(circle at 35% 30%,#fde68a,var(--gold) 50%,#b45309 100%)!important;
  box-shadow:0 0 16px var(--gold-glow),0 0 32px rgba(240,180,41,.25),0 4px 8px rgba(0,0,0,.4)!important
}
.rhythm-ball::after{
  content:'';position:absolute;top:2px;left:3px;width:40%;height:35%;
  background:radial-gradient(ellipse,rgba(255,255,255,.7),transparent);border-radius:50%
}
.rhythm-ball.big{
  background:radial-gradient(circle at 35% 30%,#fff7cc,#f0b429 40%,#92400e 100%)!important;
  box-shadow:0 0 24px var(--gold-glow),0 0 48px rgba(240,180,41,.3),0 6px 12px rgba(0,0,0,.5)!important
}

/* --- Stress dots ‚Äî gold glow on active --- */
.stress-dot.big{
  background:radial-gradient(circle at 40% 35%,#fde68a,var(--gold))!important;
  box-shadow:0 0 12px var(--gold-glow),0 0 24px rgba(240,180,41,.2)!important
}
.stress-word.active .stress-dot{
  animation:stressPulse 0.8s ease infinite!important;
  box-shadow:0 0 18px var(--gold-glow),0 0 36px rgba(240,180,41,.3)!important
}
@keyframes stressPulse{
  0%,100%{transform:scale(1);box-shadow:0 0 12px var(--gold-glow)}
  50%{transform:scale(1.2);box-shadow:0 0 24px var(--gold-glow),0 0 40px rgba(240,180,41,.25)}
}

/* --- Day selector pills ‚Äî glass effect --- */
.day-pill{
  background:rgba(20,25,41,.5)!important;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.08)!important;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.05),0 2px 8px rgba(0,0,0,.2);
  border-radius:14px;transition:all .25s ease
}
.day-pill.active{
  background:linear-gradient(135deg,rgba(99,102,241,.25),rgba(240,180,41,.15))!important;
  border-color:var(--gold)!important;
  box-shadow:0 0 16px rgba(240,180,41,.2),0 0 32px rgba(99,102,241,.1),inset 0 1px 0 rgba(255,255,255,.1)!important;
  transform:scale(1.05)
}
.day-pill.active .day-pill-badge{background:linear-gradient(135deg,var(--pri),var(--gold))!important;box-shadow:0 0 8px rgba(240,180,41,.3)}
.day-pill.locked{
  opacity:.35!important;
  background:rgba(20,25,41,.3)!important;
  border-color:rgba(255,255,255,.03)!important
}

/* --- Quiz option cards --- */
.quiz-opt{
  background:rgba(20,25,41,.6)!important;
  border:1.5px solid rgba(255,255,255,.08)!important;
  border-radius:14px;
  box-shadow:0 2px 8px rgba(0,0,0,.15);
  transition:all .2s ease,transform .15s ease;
  position:relative;overflow:visible
}
.quiz-opt:hover,.quiz-opt:focus{
  border-color:rgba(240,180,41,.3)!important;
  box-shadow:0 0 16px rgba(240,180,41,.1),0 4px 12px rgba(0,0,0,.2)
}
.quiz-opt.correct{
  border-color:var(--emerald)!important;
  background:rgba(52,211,153,.12)!important;
  box-shadow:0 0 20px rgba(52,211,153,.2)!important;
  animation:correctPop .5s ease
}
@keyframes correctPop{0%{transform:scale(1)}30%{transform:scale(1.03)}100%{transform:scale(1)}}
.quiz-opt.correct::after{
  content:'\2713';position:absolute;right:16px;top:50%;transform:translateY(-50%);
  font-size:20px;font-weight:900;color:var(--emerald);
  animation:checkIn .4s ease both
}
@keyframes checkIn{
  0%{opacity:0;transform:translateY(-50%) scale(0)}
  60%{transform:translateY(-50%) scale(1.3)}
  100%{opacity:1;transform:translateY(-50%) scale(1)}
}
.quiz-opt.wrong{
  border-color:var(--red)!important;
  background:rgba(239,68,68,.1)!important;
  animation:shake .5s ease
}
.quiz-opt.wrong::after{
  content:'\2717';position:absolute;right:16px;top:50%;transform:translateY(-50%);
  font-size:20px;font-weight:900;color:var(--red);
  animation:checkIn .4s ease both
}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}

/* --- Quiz overlay & results --- */
.quiz-overlay{background:linear-gradient(165deg,var(--bg) 0%,var(--bg2) 100%)!important}
.quiz-next-btn{
  background:linear-gradient(135deg,var(--pri),#818cf8)!important;
  box-shadow:0 4px 12px rgba(99,102,241,.3);
  transition:transform .15s ease,box-shadow .15s ease
}
.quiz-next-btn:active{transform:scale(.96)!important;box-shadow:0 2px 6px rgba(99,102,241,.2)}
.quiz-score-num{
  background:linear-gradient(135deg,var(--emerald),#6ee7b7);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;filter:drop-shadow(0 0 20px rgba(52,211,153,.3))
}
.quiz-xp{text-shadow:0 0 16px var(--gold-glow)}
.quiz-feedback.right{border:1px solid rgba(52,211,153,.2)}
.quiz-feedback.wrong{border:1px solid rgba(239,68,68,.2)}

/* --- Waveform area ‚Äî neon glow --- */
.compare-area{
  background:rgba(20,25,41,.6)!important;
  border:1px solid rgba(99,102,241,.15)!important;
  box-shadow:0 0 20px rgba(99,102,241,.08),0 0 40px rgba(99,102,241,.04),0 4px 12px rgba(0,0,0,.2);
  border-radius:16px;
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)
}
.waveform-canvas{
  border:1px solid rgba(99,102,241,.15);
  box-shadow:inset 0 0 12px rgba(99,102,241,.08);
  border-radius:10px
}

/* --- Audio buttons ‚Äî premium --- */
.audio-btn{
  box-shadow:0 2px 8px rgba(0,0,0,.25),0 4px 16px rgba(0,0,0,.15)!important;
  transition:transform .15s ease,box-shadow .15s ease!important
}
.audio-btn:active{transform:scale(.96)!important;box-shadow:0 1px 4px rgba(0,0,0,.2)!important}
.audio-btn.primary{background:linear-gradient(135deg,var(--pri),#818cf8)!important}
.audio-btn.slow{background:linear-gradient(135deg,var(--emerald),#6ee7b7)!important}

/* --- Sections ‚Äî layered depth --- */
.variant{
  background:rgba(26,31,53,.6)!important;border-left:3px solid var(--pri);
  border-radius:10px;transition:transform .15s ease
}
.variant:hover{transform:translateX(4px)}
.trap{border-radius:10px}
.tip{border-radius:10px}
.pattern{border-radius:10px}

/* --- Learn button --- */
.learn-btn.unlearned{
  background:rgba(30,30,46,.5)!important;border:1px solid rgba(255,255,255,.06);
  transition:all .25s ease
}
.learn-btn.learned{
  background:rgba(52,211,153,.1)!important;border:1px solid rgba(52,211,153,.2);
  box-shadow:0 0 16px rgba(52,211,153,.1)
}

/* --- Quiz trigger glow --- */
.quiz-trigger{
  border-color:var(--gold)!important;color:var(--gold)!important;
  box-shadow:0 0 16px rgba(240,180,41,.08);
  transition:all .25s ease
}

/* --- Nav buttons --- */
.nav{background:linear-gradient(transparent,var(--bg) 30%)!important}
.nav-btn{
  background:rgba(20,25,41,.7)!important;
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 4px 12px rgba(0,0,0,.3)!important;
  transition:all .2s ease!important
}
.nav-btn:active{
  background:linear-gradient(135deg,var(--pri),var(--gold))!important;
  transform:scale(.92)!important;
  box-shadow:0 0 16px rgba(99,102,241,.3)!important
}

/* --- Page transitions --- */
.card.slide-l{transform:translateX(-40px)!important;opacity:0}
.card.slide-r{transform:translateX(40px)!important;opacity:0}

/* --- XP & badge glow --- */
.xp-num{text-shadow:0 0 8px var(--gold-glow)}
.badge{
  background:linear-gradient(135deg,var(--pri),#818cf8)!important;
  box-shadow:0 2px 8px rgba(99,102,241,.3)
}

/* --- Score ring glow --- */
.score-ring-container{filter:drop-shadow(0 0 12px rgba(52,211,153,.2))}

/* --- CN helper warm --- */
.cn-helper{
  background:rgba(240,180,41,.06)!important;
  border-color:rgba(240,180,41,.12)!important;
  color:var(--gold)
}

/* --- Toggle switch --- */
.toggle{background:rgba(30,30,46,.6)!important;border:1px solid rgba(255,255,255,.08)}
.toggle.on{background:linear-gradient(135deg,var(--pri),var(--gold))!important;border-color:transparent}

/* --- Day overview badges --- */
.day-ov-badge{
  background:rgba(20,25,41,.5)!important;
  border:1px solid rgba(255,255,255,.05);
  backdrop-filter:blur(4px)
}
.day-ov-badge.active{border-color:rgba(99,102,241,.3)!important;box-shadow:0 0 8px rgba(99,102,241,.1)}

/* --- Text warmth --- */
.sentence{color:var(--cream);text-shadow:0 1px 2px rgba(0,0,0,.2)}

/* --- Scrollbar --- */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}

/* --- Recording states --- */
.rec-btn{border-color:rgba(255,255,255,.12)!important}
.rec-btn.recording{box-shadow:0 0 20px rgba(239,68,68,.3),0 0 40px rgba(239,68,68,.15)!important}
.rec-hist-item{
  background:rgba(10,10,15,.5)!important;
  border:1px solid rgba(255,255,255,.05)
}
.rec-hist-item.active{border-color:var(--emerald)!important;box-shadow:0 0 8px rgba(52,211,153,.15)}

/* ========== SPACED REPETITION & DAILY CHALLENGE ========== */

/* Review overlay */
.review-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(165deg,var(--bg) 0%,var(--bg2) 100%);z-index:100;display:none;flex-direction:column;padding:max(20px,env(safe-area-inset-top,20px)) 20px calc(env(safe-area-inset-bottom) + 20px);overflow-y:auto}
.review-overlay.active{display:flex}

/* SR Rating buttons */
.sr-rating-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px}
.sr-rate-btn{flex:1;min-width:70px;padding:14px 8px;border-radius:14px;border:none;font-size:14px;font-weight:700;cursor:pointer;color:white;text-align:center;transition:transform .15s,box-shadow .15s;line-height:1.3}
.sr-rate-btn:active{transform:scale(.93)}
.sr-rate-btn span{font-size:11px;font-weight:400;opacity:.8;display:block;margin-top:2px}
.sr-again{background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 2px 12px rgba(239,68,68,.3)}
.sr-hard{background:linear-gradient(135deg,#f59e0b,#d97706);box-shadow:0 2px 12px rgba(245,158,11,.3)}
.sr-good{background:linear-gradient(135deg,#10b981,#059669);box-shadow:0 2px 12px rgba(16,185,129,.3)}
.sr-easy{background:linear-gradient(135deg,#6366f1,#4f46e5);box-shadow:0 2px 12px rgba(99,102,241,.3)}

/* Challenge overlay */
.challenge-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(165deg,var(--bg) 0%,var(--bg2) 100%);z-index:100;display:none;flex-direction:column;padding:max(20px,env(safe-area-inset-top,20px)) 20px calc(env(safe-area-inset-bottom) + 20px);overflow-y:auto}
.challenge-overlay.active{display:flex}

/* Timer */
.dc-timer-wrap{background:var(--card);padding:6px 16px;border-radius:20px;border:1px solid rgba(255,255,255,.08)}
.dc-timer{font-size:18px;font-weight:900;font-variant-numeric:tabular-nums;color:var(--ok)}
.dc-timer-bar-wrap{height:4px;background:#1e1e2e;border-radius:2px;margin-bottom:16px;overflow:hidden}
.dc-timer-bar{height:100%;background:linear-gradient(90deg,var(--ok),var(--acc));border-radius:2px;transition:width .25s linear}

/* Challenge streak */
.dc-streak-display{display:flex;align-items:center;justify-content:center;gap:8px;margin-top:16px;padding:12px 20px;background:var(--card);border-radius:14px;border:1px solid rgba(240,180,41,.15)}

/* Menu action buttons */
.menu-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.menu-action-btn{flex:1;min-width:140px;padding:14px 16px;border-radius:14px;border:none;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform .15s,box-shadow .15s;position:relative}
.menu-action-btn:active{transform:scale(.96)}
.menu-action-btn.review-btn{background:linear-gradient(135deg,rgba(99,102,241,.15),rgba(99,102,241,.08));color:var(--pri);border:1.5px solid rgba(99,102,241,.25)}
.menu-action-btn.review-btn:hover{box-shadow:0 0 16px rgba(99,102,241,.15)}
.menu-action-btn.challenge-btn{background:linear-gradient(135deg,rgba(240,180,41,.15),rgba(240,180,41,.08));color:var(--acc);border:1.5px solid rgba(240,180,41,.25)}
.menu-action-btn.challenge-btn:hover{box-shadow:0 0 16px rgba(240,180,41,.15)}
.sr-badge{position:absolute;top:-6px;right:-6px;background:var(--red);color:white;font-size:11px;font-weight:800;min-width:20px;height:20px;border-radius:10px;display:flex;align-items:center;justify-content:center;padding:0 6px;box-shadow:0 2px 6px rgba(239,68,68,.4)}

/* ========== END PREMIUM OVERHAUL ========== */

/* === AI COACH DASHBOARD === */
.coach-tab { position:fixed; top:50%; right:0; transform:translateY(-50%); background:linear-gradient(135deg,var(--pri),var(--gold)); color:white; padding:12px 8px; border-radius:12px 0 0 12px; font-size:12px; font-weight:800; writing-mode:vertical-rl; cursor:pointer; z-index:30; box-shadow:-2px 0 12px rgba(99,102,241,.3); letter-spacing:1px }
.coach-panel { position:fixed; top:0; right:-320px; width:320px; height:100%; background:var(--bg); border-left:1px solid rgba(255,255,255,.08); z-index:100; transition:right .3s ease; overflow-y:auto; padding:20px; padding-top:max(20px,env(safe-area-inset-top)) }
.coach-panel.open { right:0 }
.coach-close { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--dim); font-size:24px; cursor:pointer }
.coach-section { margin-bottom:20px }
.coach-section h3 { font-size:14px; color:var(--acc); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px }
.weakness-bar { height:6px; background:#1e1e2e; border-radius:3px; margin:4px 0 8px; overflow:hidden }
.weakness-fill { height:100%; border-radius:3px; transition:width .5s ease }
.coach-tip { background:rgba(99,102,241,.08); border:1px solid rgba(99,102,241,.15); border-radius:10px; padding:10px 12px; font-size:13px; color:var(--txt); line-height:1.5; margin-bottom:8px }
.coach-stat { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.05); font-size:13px }
.coach-stat-val { color:var(--acc); font-weight:700 }

/* === SHADOWING MODE === */
.shadow-overlay { position:fixed; inset:0; background:var(--bg); z-index:100; display:none; flex-direction:column; padding:max(20px,env(safe-area-inset-top,20px)) 20px calc(env(safe-area-inset-bottom)+20px); overflow-y:auto }
.shadow-overlay.active { display:flex }
.shadow-step { background:var(--card); border-radius:14px; padding:16px; margin-bottom:12px; border-left:4px solid var(--dim); transition:all .3s }
.shadow-step.current { border-left-color:var(--acc); box-shadow:0 0 16px rgba(240,180,41,.1) }
.shadow-step.done { border-left-color:var(--ok); opacity:.7 }
.shadow-step-num { font-size:12px; color:var(--dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:4px }
.shadow-step-title { font-size:16px; font-weight:700; margin-bottom:8px }
.shadow-step-desc { font-size:13px; color:var(--dim); line-height:1.5 }
.shadow-chunks { display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 }
.shadow-chunk { padding:8px 14px; border-radius:10px; background:rgba(99,102,241,.1); border:1px solid rgba(99,102,241,.2); font-size:14px; font-weight:600; cursor:pointer; transition:all .15s }
.shadow-chunk.active { background:var(--pri); color:white; transform:scale(1.05) }
.shadow-chunk.done { background:rgba(52,211,153,.1); border-color:rgba(52,211,153,.2); color:var(--ok) }

/* === PITCH CONTOUR === */
.pitch-canvas { width:100%; height:80px; border-radius:10px; background:#0a0a0f; border:1px solid rgba(99,102,241,.15); display:block; margin:8px 0 }
.pitch-legend { display:flex; gap:16px; justify-content:center; font-size:11px; color:var(--dim); margin-bottom:8px }
.pitch-legend span::before { content:''; display:inline-block; width:12px; height:3px; border-radius:2px; margin-right:4px; vertical-align:middle }
.pitch-legend .native::before { background:var(--pri) }
.pitch-legend .user::before { background:var(--ok) }

/* === CONNECTED SPEECH HIGHLIGHTS === */
.linked-words { text-decoration:underline; text-decoration-color:var(--acc); text-decoration-style:wavy; text-underline-offset:3px }
.phoneme-tip { display:inline-block; background:rgba(239,68,68,.1); color:var(--red); padding:2px 6px; border-radius:4px; font-size:11px; margin:2px }

/* === AI SCORE ENHANCED === */
.ai-score-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:12px 0 }
.ai-score-item { background:rgba(20,25,41,.5); border-radius:10px; padding:10px; text-align:center }
.ai-score-item label { font-size:10px; color:var(--dim); text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px }
.ai-score-item .val { font-size:22px; font-weight:900 }

/* === SHADOWING TRIGGER === */
.shadow-trigger { width:100%; padding:14px; border-radius:12px; border:2px solid var(--pri); background:rgba(99,102,241,.08); color:var(--pri); font-size:15px; font-weight:700; cursor:pointer; margin-top:8px; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:8px }
.shadow-trigger:active { background:rgba(99,102,241,.2); transform:scale(.97) }

/* === VISUAL SCENE & LEARNING FLOW === */

/* Learning step indicators */
.learning-steps { display:flex; justify-content:center; gap:4px; margin-bottom:14px; padding:8px 0; flex-wrap:wrap }
.learning-step { display:flex; align-items:center; gap:4px; padding:6px 10px; border-radius:20px; font-size:12px; font-weight:600; color:var(--dim); background:rgba(30,30,46,.4); transition:all .3s; white-space:nowrap }
.learning-step.active { background:linear-gradient(135deg,rgba(99,102,241,.25),rgba(240,180,41,.15)); color:var(--acc); border:1px solid rgba(240,180,41,.3); box-shadow:0 0 12px rgba(240,180,41,.15) }
.learning-step.done { color:var(--ok); background:rgba(52,211,153,.08) }
.learning-step-num { font-size:11px; font-weight:900; min-width:18px; height:18px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.08) }
.learning-step.active .learning-step-num { background:var(--acc); color:var(--bg) }
.learning-step.done .learning-step-num { background:var(--ok); color:var(--bg) }
.learning-step-arrow { font-size:10px; color:var(--dim); margin:0 2px }

/* Scene card immersive */
.scene-card-immersive { border-radius:20px; padding:28px 20px 22px; text-align:center; margin-bottom:16px; position:relative; overflow:hidden; display:flex; flex-direction:column; align-items:center; justify-content:center; box-shadow:0 4px 6px rgba(0,0,0,.2),0 12px 24px rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.08) }
.scene-card-immersive::after { content:''; position:absolute; top:-50%; right:-50%; width:100%; height:100%; background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%); pointer-events:none }
.scene-emojis { font-size:52px; margin-bottom:8px; filter:drop-shadow(0 4px 12px rgba(0,0,0,.4)); letter-spacing:4px; animation:emojiFloat 3s ease-in-out infinite }
@keyframes emojiFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
.scene-context-zh { font-size:15px; color:rgba(255,255,255,.85); margin-bottom:10px; line-height:1.5; font-weight:500 }
.scene-phrase-en { font-size:26px; font-weight:900; color:white; letter-spacing:1px; text-shadow:0 2px 8px rgba(0,0,0,.3); margin-bottom:6px; line-height:1.3 }
.scene-translation-zh { font-size:16px; color:rgba(255,255,255,.7); font-weight:500 }
.scene-badge { position:absolute; top:12px; right:12px; font-size:11px; padding:3px 10px; border-radius:12px; background:rgba(0,0,0,.3); color:rgba(255,255,255,.7); backdrop-filter:blur(4px); font-weight:600 }

/* Category tabs */
.category-tabs { display:flex; gap:6px; margin-bottom:12px; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; padding-bottom:4px; scrollbar-width:none }
.category-tabs::-webkit-scrollbar { display:none }
.cat-tab { flex-shrink:0; padding:8px 14px; border-radius:20px; font-size:13px; font-weight:600; cursor:pointer; background:rgba(20,25,41,.5); color:var(--dim); border:1px solid rgba(255,255,255,.06); transition:all .2s; scroll-snap-align:start; white-space:nowrap }
.cat-tab:active { transform:scale(.95) }
.cat-tab.active { background:linear-gradient(135deg,rgba(99,102,241,.2),rgba(240,180,41,.12)); color:var(--acc); border-color:rgba(240,180,41,.3); box-shadow:0 0 10px rgba(240,180,41,.1) }

/* Step section labels in Chinese */
.step-label { display:flex; align-items:center; gap:6px; font-size:13px; font-weight:700; color:var(--acc); text-transform:none; letter-spacing:0; margin-bottom:10px }
.step-label .step-icon { font-size:16px }
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <h1>ËäÇÂ•èËã±ËØ≠</h1>
    <div class="hdr-right">
      <div class="mode-toggle">
        <label>‰∏≠Êñá</label>
        <button class="toggle" id="cnToggle" onclick="toggleCN()" role="switch" aria-checked="false" aria-label="Toggle Chinese mode"></button>
      </div>
      <div class="xp-display"><span style="font-weight:800;color:var(--acc)">XP</span> <span class="xp-num" id="xpNum">0</span></div>
      <div class="badge" id="dayBadge">Day 1</div>
    </div>
  </div>
  <div class="streak-bar" id="streakBar"></div>
  <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Learning progress" id="progBar"><div class="progress-fill" id="prog"></div></div>
  <div class="complete-summary" id="completeSummary"></div>
  <div class="day-switcher" id="daySwitcher"></div>
  <div class="day-overview" id="dayOverview"></div>
  <div class="category-tabs" id="categoryTabs"></div>
  <div class="card" id="card"></div>
</div>
<!-- Quiz overlay -->
<div class="quiz-overlay" id="quizOverlay" role="dialog" aria-modal="true" aria-label="Quiz">
  <div class="quiz-progress" id="quizProgress" role="progressbar" aria-label="Quiz progress"></div>
  <div id="quizContent"></div>
</div>
<!-- Review overlay (Spaced Repetition) -->
<div class="review-overlay" id="reviewOverlay" role="dialog" aria-modal="true" aria-label="Review">
  <div id="reviewContent"></div>
</div>
<!-- Daily Challenge overlay -->
<div class="challenge-overlay" id="challengeOverlay" role="dialog" aria-modal="true" aria-label="Daily Challenge">
  <div id="challengeContent"></div>
</div>

<!-- Shadowing Mode overlay -->
<div class="shadow-overlay" id="shadowOverlay" role="dialog" aria-modal="true" aria-label="Ë∑üËØªÁªÉ‰π†">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <h2 style="font-size:20px;font-weight:900">Ë∑üËØªÁªÉ‰π†</h2>
    <button onclick="ShadowMode.close()" style="background:none;border:none;color:var(--dim);font-size:24px;cursor:pointer">&times;</button>
  </div>
  <div id="shadowContent"></div>
</div>

<!-- AI Coach Panel -->
<div class="coach-tab" id="coachTab" onclick="CoachPanel.toggle()">AI ÊïôÁªÉ</div>
<div class="coach-panel" id="coachPanel">
  <button class="coach-close" onclick="CoachPanel.toggle()">&times;</button>
  <h2 style="font-size:18px;font-weight:900;margin-bottom:4px;background:linear-gradient(135deg,var(--pri),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">AI ÊïôÁªÉ</h2>
  <p style="font-size:12px;color:var(--dim);margin-bottom:16px">‰Ω†ÁöÑ‰∏ìÂ±ûÂèëÈü≥ÊåáÂØº</p>
  <div id="coachContent"></div>
</div>

<div class="nav">
  <button class="nav-btn" id="prev" onclick="go(-1)" aria-label="Previous sentence">‚Üê</button>
  <span class="nav-count" id="count" aria-live="polite"></span>
  <button class="nav-btn" id="next" onclick="go(1)" aria-label="Next sentence">‚Üí</button>
  <button class="nav-btn" id="custom" onclick="CustomPractice.show()" aria-label="Ëá™Áî±ÁªÉ‰π†" style="margin-left:8px;background:var(--ok)">‚úèÔ∏è</button>
</div>

<!-- Custom Practice Modal -->
<div id="customModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:100;align-items:center;justify-content:center">
  <div style="background:var(--card);padding:24px;border-radius:16px;width:90%;max-width:400px">
    <h3 style="margin-bottom:16px">‚úèÔ∏è Ëá™Áî±ÁªÉ‰π†</h3>
    <p style="color:var(--dim);font-size:13px;margin-bottom:12px">ËæìÂÖ•‰ªª‰ΩïËã±ËØ≠Âè•Â≠êÊù•ÁªÉ‰π†ÂèëÈü≥</p>
    <textarea id="customInput" rows="3" style="width:100%;background:var(--bg);border:1px solid var(--dim);border-radius:8px;color:var(--txt);padding:12px;font-size:16px" placeholder="‰æãÂ¶ÇÔºöI need to finish the report by Friday"></textarea>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button onclick="CustomPractice.play(0.8)" style="flex:1;background:var(--pri);color:white;border:none;padding:12px;border-radius:8px;font-weight:600">üê¢ ÊÖ¢ÈÄü</button>
      <button onclick="CustomPractice.play(1)" style="flex:1;background:var(--ok);color:white;border:none;padding:12px;border-radius:8px;font-weight:600">‚ñ∂Ô∏è Ê≠£Â∏∏</button>
    </div>
    <div style="margin-top:16px">
      <button onclick="document.getElementById('customModal').style.display='none'" style="width:100%;background:transparent;border:1px solid var(--dim);color:var(--dim);padding:10px;border-radius:8px">ÂÖ≥Èó≠</button>
    </div>
  </div>
</div>

<script>
const CustomPractice={
  show(){document.getElementById('customModal').style.display='flex';document.getElementById('customInput').focus()},
  play(rate){
    const text=document.getElementById('customInput').value.trim();
    if(!text){alert('ËØ∑ËæìÂÖ•Ëã±ËØ≠Âè•Â≠ê');return;}
    if(typeof speechSynthesis!=='undefined'){
      speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      u.lang='en-US';u.rate=rate*0.85;
      speechSynthesis.speak(u);
    }
  }
};
window.CustomPractice=CustomPractice;
</script>
<script type="module">
import{DAY1,SCENES}from'./data/sentences.js';
import{DAY2,SCENES_DAY2}from'./data/day2.js';
import{DAY3,SCENES_DAY3}from'./data/day3.js';
import{DAY4,SCENES_DAY4}from'./data/day4.js';
import{DAY5,SCENES_DAY5}from'./data/day5.js';
import{DAY6,SCENES_DAY6}from'./data/day6.js';
import{DAY7,SCENES_DAY7}from'./data/day7.js';
import{DAY8,SCENES_DAY8}from'./data/day8.js';
import{DAY9,SCENES_DAY9}from'./data/day9.js';
import{DAY10,SCENES_DAY10}from'./data/day10.js';
import{DAY11,SCENES_DAY11}from'./data/day11.js';
import{DAY12,SCENES_DAY12}from'./data/day12.js';
import{DAY13,SCENES_DAY13}from'./data/day13.js';
import{DAY14,SCENES_DAY14}from'./data/day14.js';
import{generateDay}from'./data/generator.js';
import{createEngine}from'./modules/ai-engine.js';
import{PatternLibrary,ConnectedSpeechRules,IntonationPatterns,ShadowingScript,WeaknessProfiler,LIFE_CATEGORIES}from'./modules/content-engine.js';

/* ---- AI Engine ---- */
let aiEngine=null;
try{aiEngine=createEngine();}catch(e){console.warn('AI engine init:',e);}
const patternLib=new PatternLibrary();
const speechRules=new ConnectedSpeechRules();
const intonationPatterns=new IntonationPatterns();
const weaknessProfiler=new WeaknessProfiler();

/* ---- Day Management ---- */
let currentDay=parseInt(localStorage.getItem('re-currentDay')||'1')||1;
const ALL_DAYS=[DAY1,DAY2,DAY3,DAY4,DAY5,DAY6,DAY7,DAY8,DAY9,DAY10,DAY11,DAY12,DAY13,DAY14];
const ALL_SCENES=[SCENES,SCENES_DAY2,SCENES_DAY3,SCENES_DAY4,SCENES_DAY5,SCENES_DAY6,SCENES_DAY7,SCENES_DAY8,SCENES_DAY9,SCENES_DAY10,SCENES_DAY11,SCENES_DAY12,SCENES_DAY13,SCENES_DAY14];
/* ---- Generated day cache ---- */
const generatedCache={};
function getGeneratedDay(day){if(!generatedCache[day])generatedCache[day]=generateDay(day);return generatedCache[day];}
function getSentences(){if(currentDay<=14)return ALL_DAYS[currentDay-1]||DAY1;return getGeneratedDay(currentDay).sentences;}
function getScenes(){if(currentDay<=14)return ALL_SCENES[currentDay-1]||SCENES;return getGeneratedDay(currentDay).scenes;}

/* ---- Migrate old single-day progress (one-time) ---- */
(function(){
  const old=localStorage.getItem('re-progress');
  if(old){localStorage.setItem('re-progress-day1',old);localStorage.removeItem('re-progress');}
  const oi=localStorage.getItem('re-idx');
  if(oi!==null){localStorage.setItem('re-idx-day1',oi);localStorage.removeItem('re-idx');}
})();

let idx=parseInt(localStorage.getItem(`re-idx-day${currentDay}`)||'0')||0;
let cnMode=localStorage.getItem('re-cn')==='1';
const $=s=>document.querySelector(s);
let audio=null;

/* ---- Recording State ---- */
let mediaRecorder=null,isRecording=false,recChunks=[],recBlob=null,recUrl=null;
let recSentenceId=null,recScore=null,recTimerId=null,recStartTime=0;
let recUserDur=null,recNativeDur=null,_userAudioBuf=null,_nativeAudioBuf=null;
let audioCtx=null;
function getAudioCtx(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive',sampleRate:44100});
  if(audioCtx.state==='suspended')audioCtx.resume();
  return audioCtx;
}
function getRecHistory(sid){return JSON.parse(localStorage.getItem(`re-rec-${sid}`)||'[]');}

/* ---- Progress (per-day) ---- */
const DEFAULT_PROGRESS={learned:[],streak:0,lastDate:null,history:[],quizBest:0};
function getProgress(day){
  const d=day||currentDay;
  try{
    const raw=localStorage.getItem(`re-progress-day${d}`);
    if(!raw)return JSON.parse(JSON.stringify(DEFAULT_PROGRESS));
    const p=JSON.parse(raw);
    // Ensure all fields exist (forward compat)
    return{...JSON.parse(JSON.stringify(DEFAULT_PROGRESS)),...p};
  }catch(e){
    console.warn('Progress data corrupted, resetting day',d,e);
    return JSON.parse(JSON.stringify(DEFAULT_PROGRESS));
  }
}
function saveProgress(p,day){
  const d=day||currentDay;
  try{localStorage.setItem(`re-progress-day${d}`,JSON.stringify(p));}
  catch(e){console.warn('Failed to save progress (storage full?)',e);}
}
function todayStr(){return new Date().toISOString().slice(0,10);}

/* ---- Day Unlock (previous day quiz >= 60%; day 15+ unlocked if day 14 done) ---- */
function isDayUnlocked(day){if(day<=1)return true;if(day<=14)return getProgress(day-1).quizBest>=60;return getProgress(14).quizBest>=60;}

/* Guard: if on a locked day, find highest unlocked day */
if(!isDayUnlocked(currentDay)){let d=1;for(let i=14;i>=1;i--){if(isDayUnlocked(i)){d=i;break;}}currentDay=d;try{localStorage.setItem('re-currentDay',String(d));}catch{}idx=parseInt(localStorage.getItem(`re-idx-day${currentDay}`)||'0')||0;}

/* ---- Switch Day ---- */
window.switchDay=function(day){
  if(!isDayUnlocked(day))return;
  // Stop any playing audio
  if(audio){audio.pause();audio.src='';audio=null;}
  if(typeof speechSynthesis!=='undefined')speechSynthesis.cancel();
  try{localStorage.setItem(`re-idx-day${currentDay}`,String(idx));}catch{}
  currentDay=day;
  try{localStorage.setItem('re-currentDay',String(day));}catch{}
  idx=parseInt(localStorage.getItem(`re-idx-day${currentDay}`)||'0')||0;
  const len=getSentences().length;
  if(idx>=len)idx=len-1;
  if(idx<0)idx=0;
  renderDaySwitcher();
  render();
};

/* ---- Render Day Switcher & Overview ---- */
function renderDaySwitcher(){
  const days=[
    {n:1,label:'Á¨¨1Â§©',sub:'ÂïÜÂä°‰ºöËÆÆ',data:DAY1},
    {n:2,label:'Á¨¨2Â§©',sub:'Ë∞àÂà§',data:DAY2},
    {n:3,label:'Á¨¨3Â§©',sub:'È¢ÜÂØºÂäõ',data:DAY3},
    {n:4,label:'Á¨¨4Â§©',sub:'‰∫ßÂìÅ/ÊäÄÊúØ',data:DAY4},
    {n:5,label:'Á¨¨5Â§©',sub:'ÂÜ≤Á™ÅËß£ÂÜ≥',data:DAY5},
    {n:6,label:'Á¨¨6Â§©',sub:'Á§æ‰∫§ÁΩëÁªú',data:DAY6},
    {n:7,label:'Á¨¨7Â§©',sub:'Âç±Êú∫Ê≤üÈÄö',data:DAY7},
    {n:8,label:'Á¨¨8Â§©',sub:'Èù¢ËØï',data:DAY8},
    {n:9,label:'Á¨¨9Â§©',sub:'ÊºîËÆ≤',data:DAY9},
    {n:10,label:'Á¨¨10Â§©',sub:'Ë∑®ÊñáÂåñ',data:DAY10},
    {n:11,label:'Á¨¨11Â§©',sub:'ËøúÁ®ãÂ∑•‰Ωú',data:DAY11},
    {n:12,label:'Á¨¨12Â§©',sub:'ÈîÄÂîÆ',data:DAY12},
    {n:13,label:'Á¨¨13Â§©',sub:'ÂÖ¨ÂºÄÊºîËÆ≤',data:DAY13},
    {n:14,label:'Á¨¨14Â§©',sub:'AI‰∏éÊú™Êù•',data:DAY14}
  ];
  // Add generated days (15-20) to the list
  for(let gd=15;gd<=20;gd++){
    const gen=getGeneratedDay(gd);
    const cats=[...new Set(gen.sentences.map(s=>s.cat))].slice(0,2).map(c=>(c.charAt(0).toUpperCase()+c.slice(1))).join('+');
    days.push({n:gd,label:`Á¨¨${gd}Â§©`,sub:cats||'ÁªºÂêà',data:gen.sentences});
  }
  let pills='',overview='';
  for(const d of days){
    const p=getProgress(d.n);
    const unlocked=isDayUnlocked(d.n);
    const pct=d.data.length?Math.round(p.learned.length/d.data.length*100):0;
    const badge=!unlocked?'Êú™Ëß£ÈîÅ':p.quizBest>0?`${p.quizBest}%`:d.n>1&&pct===0?'Êñ∞':`${pct}%`;
    pills+=`<button class="day-pill${currentDay===d.n?' active':''}${!unlocked?' locked':''}" onclick="switchDay(${d.n})">
      <span class="day-pill-label">${d.label}</span>
      <span class="day-pill-sub">${d.sub}</span>
      <span class="day-pill-badge">${badge}</span>
    </button>`;
    overview+=`<span class="day-ov-badge${currentDay===d.n?' active':''}${!unlocked?' locked':''}">${d.label} ${unlocked?(p.quizBest>=60?'ÈÄöËøá':pct>0?'...':'Êñ∞'):'--'} ${unlocked?pct+'%':'Êñ∞'}</span>`;
  }
  $('#daySwitcher').innerHTML=pills;
  $('#dayOverview').innerHTML=overview;
  $('#dayBadge').textContent=`Á¨¨${currentDay}Â§©`;
  // Auto-scroll day switcher to active pill
  const activePill=$('#daySwitcher .day-pill.active');
  if(activePill)activePill.scrollIntoView({inline:'center',block:'nearest',behavior:'smooth'});
}

/* ---- Streak Helper (DRY) ---- */
function updateStreakIfNeeded(p){
  const today=todayStr();
  if(p.lastDate!==today){
    if(p.lastDate){
      const d=new Date(p.lastDate);d.setDate(d.getDate()+1);
      p.streak=d.toISOString().slice(0,10)===today?(p.streak||0)+1:1;
    }else p.streak=1;
    p.lastDate=today;
    if(!p.history)p.history=[];
    if(!p.history.includes(today))p.history.push(today);
  }
  return p;
}

/* ---- Toggle Learned ---- */
window.toggleLearned=function(){
  const sents=getSentences();
  if(!sents.length)return;
  const p=getProgress();
  const sid=sents[idx].id;
  const i=p.learned.indexOf(sid);
  if(i>=0)p.learned.splice(i,1);else p.learned.push(sid);
  updateStreakIfNeeded(p);
  saveProgress(p);
  render();
};

/* ---- Streak ---- */
function renderStreak(){
  const p=getProgress();
  const sents=getSentences();
  const streak=p.streak||0;
  const today=todayStr();
  const dots=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().slice(0,10);const done=p.history&&p.history.includes(ds);const isToday=ds===today;dots.push(`<div class="streak-d${done?' done':''}${isToday?' today':''}"></div>`);}
  $('#streakBar').innerHTML=`
    <span class="streak-fire" style="font-size:18px;font-weight:900;color:var(--acc)">*</span>
    <span class="streak-num">${streak}</span>
    <span class="streak-label">Â§©ËøûÁª≠</span>
    <div class="streak-dots">${dots.join('')}</div>`;
  $('#completeSummary').innerHTML=`Â∑≤Â≠¶ <b>${p.learned.length}</b>/${sents.length} ‰∏™Âè•Â≠ê ¬∑ Á¨¨${currentDay}Â§©`;
}

/* ---- CN Toggle ---- */
window.toggleCN=function(){
  cnMode=!cnMode;
  try{localStorage.setItem('re-cn',cnMode?'1':'0');}catch{}
  const tog=$('#cnToggle');
  tog.classList.toggle('on',cnMode);
  tog.setAttribute('aria-checked',String(cnMode));
  render();
};

/* ---- Category Tabs ---- */
let activeCategoryFilter = null;
function renderCategoryTabs(){
  const el=$('#categoryTabs');
  if(!el)return;
  const cats = LIFE_CATEGORIES || [];
  if(!cats.length){el.innerHTML='';return;}
  let html='<button class="cat-tab'+(activeCategoryFilter===null?' active':'')+'" onclick="window.filterCategory(null)">ÂÖ®ÈÉ®</button>';
  for(const c of cats){
    html+=`<button class="cat-tab${activeCategoryFilter===c.id?' active':''}" onclick="window.filterCategory('${c.id}')">${c.label}</button>`;
  }
  el.innerHTML=html;
}
window.filterCategory=function(cat){
  activeCategoryFilter=cat;
  renderCategoryTabs();
};

/* ---- Learning Step Highlight ---- */
function updateLearningStep(stepNum){
  for(let i=1;i<=4;i++){
    const el=document.getElementById('lstep'+i);
    if(!el)continue;
    el.classList.remove('active','done');
    if(i<stepNum)el.classList.add('done');
    else if(i===stepNum)el.classList.add('active');
  }
}

/* ---- Main Render ---- */
function render(){
  if(isRecording)stopRecording();
  // Clean up any running rhythm animation
  rhythmTimers.forEach(t=>clearTimeout(t));
  rhythmTimers=[];
  // Stop comparison audio if playing
  if(cmpAudio){cmpAudio.pause();cmpAudio=null;}
  const sents=getSentences();
  const scenes=getScenes();
  if(!sents.length){
    $('#card').innerHTML='<div style="text-align:center;padding:40px 20px;color:var(--dim)"><p style="font-size:28px;margin-bottom:12px;font-weight:900">---</p><p>‰ªäÂ§©ÊöÇÊó†Âè•Â≠êÂä†ËΩΩ„ÄÇ</p></div>';
    $('#count').textContent='0 / 0';
    $('#prog').style.width='0%';
    return;
  }
  if(idx>=sents.length)idx=sents.length-1;
  if(idx<0)idx=0;
  const s=sents[idx];
  if(!s)return;
  const sc=scenes[s.id]||{icon:"...",colors:["#6366f1","#818cf8"],title:"",sub:""};
  const p=getProgress();
  const tog=$('#cnToggle');
  tog.classList.toggle('on',cnMode);
  tog.setAttribute('aria-checked',String(cnMode));
  const pctVal=Math.round((idx+1)/sents.length*100);
  $('#prog').style.width=pctVal+'%';
  const progBar=$('#progBar');
  if(progBar){progBar.setAttribute('aria-valuenow',String(pctVal));}
  $('#count').textContent=`${idx+1} / ${sents.length}`;
  $('#prev').disabled=idx===0;
  $('#next').disabled=idx===sents.length-1;
  const dots=s.words.map((w,i)=>{
    const stressed=s.stress[i]>=0.8;
    const mid=s.stress[i]>=0.4&&s.stress[i]<0.8;
    const size=stressed?36:mid?22:14;
    const cls=stressed?'big':'small';
    const lblCls=stressed?'loud':'';
    return`<div class="stress-word"><div class="stress-dot ${cls}" style="width:${size}px;height:${size}px"></div><span class="stress-label ${lblCls}">${stressed?w.toUpperCase():w}</span></div>`;
  }).join('');
  // Generate Chinese phoneme tips for this sentence
  let phonemeTipsHtml='';
  if(aiEngine&&aiEngine.phonemeMapper){
    try{
      const sentenceErrors=aiEngine.phonemeMapper.getSentenceErrors(s.words);
      if(sentenceErrors.length>0){
        phonemeTipsHtml='<div class="section"><div class="section-label">Â∏∏ËßÅÈîôËØØÔºà‰∏≠ÂõΩ‰∫∫ÊòìÈîôÔºâ</div>';
        sentenceErrors.slice(0,4).forEach(e=>{
          phonemeTipsHtml+=`<div class="tip" style="margin-bottom:6px;white-space:pre-line">${e.tipCn}</div>`;
        });
        phonemeTipsHtml+='</div>';
      }
    }catch(e){}
  }
  // Difficulty indicator
  const stressedCount=s.stress.filter(x=>x>=0.8).length;
  const wordCount=s.words.length;
  const diffLevel=wordCount<=3?'ÁÆÄÂçï':wordCount<=6?(stressedCount>=3?'‰∏≠Á≠â':'ÁÆÄÂçï'):'ËæÉÈöæ';
  const diffColor=diffLevel==='ÁÆÄÂçï'?'var(--ok)':diffLevel==='‰∏≠Á≠â'?'var(--acc)':'var(--red)';

  // Scene emoji from sentence data or fallback to scene icon
  const sceneEmojis = (s.scene && s.scene.length <= 10) ? s.scene : sc.icon;

  // Render category tabs
  renderCategoryTabs();

  $('#card').innerHTML=`
    <!-- Learning step indicators: ÁúãÂú∫ÊôØ ‚Üí Âê¨ÂèëÈü≥ ‚Üí Ë∑üÊàëËØª ‚Üí ÁúãÁªìÊûú -->
    <div class="learning-steps">
      <div class="learning-step active" id="lstep1"><span class="learning-step-num">1</span> ÁúãÂú∫ÊôØ</div>
      <span class="learning-step-arrow">‚Üí</span>
      <div class="learning-step" id="lstep2"><span class="learning-step-num">2</span> Âê¨ÂèëÈü≥</div>
      <span class="learning-step-arrow">‚Üí</span>
      <div class="learning-step" id="lstep3"><span class="learning-step-num">3</span> Ë∑üÊàëËØª</div>
      <span class="learning-step-arrow">‚Üí</span>
      <div class="learning-step" id="lstep4"><span class="learning-step-num">4</span> ÁúãÁªìÊûú</div>
    </div>

    <div class="cat">${s.cat} ¬∑ ${idx+1}/${sents.length}
      <span style="margin-left:8px;font-size:11px;padding:2px 8px;border-radius:8px;background:rgba(255,255,255,0.06);color:${diffColor};font-weight:700">ÈöæÂ∫¶Ôºö${diffLevel}</span>
    </div>

    <!-- ‚ë† ÁúãÂú∫ÊôØ ‚Äî Visual Scene Context (FIRST!) -->
    <div class="scene-card-immersive" style="background:linear-gradient(135deg,${sc.colors[0]},${sc.colors[1]})">
      <div class="scene-badge">${sc.title||s.cat}</div>
      <div class="scene-emojis">${sceneEmojis}</div>
      <div class="scene-context-zh">${sc.sub||''}</div>
      <div class="scene-phrase-en">${s.text}</div>
      <div class="scene-translation-zh">${s.cn}</div>
    </div>

    <!-- ‚ë° Âê¨ÂèëÈü≥ ‚Äî Listen & See Stress -->
    <div class="step-label"><span class="step-icon">üëÇ</span> Âê¨‰∏ÄÂê¨</div>
    <div class="stress-row">${dots}</div>
    <div class="sentence">${s.text}</div>
    <div class="ipa">${s.ipa}</div>
    <div class="audio-row">
      <button class="audio-btn primary" id="playBtn" onclick="window.speak()" aria-label="Âê¨‰∏ÄÂê¨">&#9654; Âê¨‰∏ÄÂê¨</button>
      <button class="audio-btn slow" onclick="window.speakSlow()" aria-label="ÊÖ¢ÈÄüÊí≠Êîæ">ÊÖ¢ÈÄü 0.7x</button>
      <button class="audio-btn" style="background:#f59e0b" onclick="window.rhythmPlay()" aria-label="ËäÇÊãçÂä®Áîª">&#9835; ËäÇÊãç</button>
    </div>

    <!-- ‚ë¢ Ë∑üÊàëËØª ‚Äî Record Your Voice -->
    <div class="step-label"><span class="step-icon">üéôÔ∏è</span> Ë∑üÊàëËØª</div>
    <div class="audio-row">
      <button class="audio-btn rec-btn" id="recBtn" onclick="window.toggleRecord()" aria-label="ÂΩïÈü≥" style="flex:1;max-width:200px;justify-content:center">&#9679; ÂΩïÈü≥</button>
    </div>

    <!-- ‚ë£ ÁúãÁªìÊûú ‚Äî See Your Results -->
    <div id="recCompare"></div>
    <div class="pitch-legend"><span class="native">Ê†áÂáÜÂèëÈü≥</span><span class="user">‰Ω†ÁöÑÂèëÈü≥</span></div>
    <canvas class="pitch-canvas" id="pitchCanvas"></canvas>

    <button class="shadow-trigger" onclick="ShadowMode.start()">&#127919; Ë∑üËØªÁªÉ‰π†</button>

    <div class="section">
      <div class="section-label">ËøôÂè•ËØùÁöÑÊÑèÊÄù</div>
      <div class="section-text">${s.meaning}</div>
    </div>
    ${phonemeTipsHtml}
    <div class="section">
      <div class="section-label">Âè•Âûã</div>
      <div class="pattern">${s.pattern}</div>
    </div>
    <div class="section">
      <div class="section-label">ÂêåÁ±ªË°®Ëææ</div>
      <div class="variants">${s.variants.map(v=>`<div class="variant">${v}</div>`).join('')}</div>
    </div>
    <div class="section">
      <div class="section-label">ËäÇÂ•èÊèêÁ§∫</div>
      <div class="tip">${s.tip}</div>
    </div>
    <div class="section">
      <div class="section-label">‰∏≠ÂºèËã±ËØ≠Èô∑Èò±</div>
      <div class="trap">${s.trap}</div>
    </div>
    <button class="learn-btn ${p.learned.includes(s.id)?'learned':'unlearned'}" onclick="window.toggleLearned()" aria-label="${p.learned.includes(s.id)?'ÂèñÊ∂àÊ†áËÆ∞':'Ê†áËÆ∞Â∑≤Â≠¶‰ºö'}" aria-pressed="${p.learned.includes(s.id)?'true':'false'}">
      ${p.learned.includes(s.id)?'&#10003; Â∑≤Â≠¶‰ºöÔºÅ':'Ê†áËÆ∞‰∏∫Â∑≤Â≠¶‰ºö'}
    </button>
    ${p.learned.length>=5?'<button class="quiz-trigger" onclick="Quiz.start()" aria-label="ÂºÄÂßãÊµãÈ™åÔºà'+p.learned.length+'‰∏™Âè•Â≠êÔºâ">ÊµãÈ™å‰∏Ä‰∏ãÔºÅÔºà'+p.learned.length+'‰∏™Âè•Â≠êÔºâ</button>':''}
    <div class="menu-actions">
      <button class="menu-action-btn review-btn" onclick="SR.start()" aria-label="Â§ç‰π†Âç°Áâá">
        üìö Â§ç‰π†${(typeof SR!=='undefined'&&SR.getDueCount()>0)?'<span class="sr-badge" id="srBadge">'+SR.getDueCount()+'</span>':''}
      </button>
      <button class="menu-action-btn challenge-btn" onclick="DailyChallenge.start()" aria-label="ÊØèÊó•ÊåëÊàò">
        ‚ö° ÊØèÊó•ÊåëÊàò
      </button>
    </div>
  `;
  renderStreak();
  renderDaySwitcher();
  renderRecCompare();
  window.scrollTo({top:0,behavior:'smooth'});
  try{localStorage.setItem(`re-idx-day${currentDay}`,idx);}catch{}
}

/* ---- Audio ---- */
function playAudio(rate=1){
  if(audio){audio.pause();audio.onplay=null;audio.onended=null;audio.onerror=null;audio.src='';audio=null;}
  if(typeof speechSynthesis!=='undefined')speechSynthesis.cancel();
  const sents=getSentences();
  if(!sents.length)return;
  const s=sents[idx];
  if(!s)return;
  const id=String(s.id).padStart(2,'0');
  audio=new Audio('audio/'+id+'.mp3');
  audio.playbackRate=rate;
  const btn=document.getElementById('playBtn');
  audio.onplay=()=>{if(btn)btn.classList.add('playing');};
  audio.onended=()=>{if(btn)btn.classList.remove('playing');};
  audio.onerror=()=>{
    if(btn)btn.classList.remove('playing');
    if(typeof speechSynthesis==='undefined')return;
    const u=new SpeechSynthesisUtterance(s.text);
    u.lang='en-US';u.rate=rate*0.85;
    speechSynthesis.speak(u);
  };
  audio.play().catch(()=>{if(audio&&audio.onerror)audio.onerror();});
}
window.speak=function(){updateLearningStep(2);playAudio(1);};
window.speakSlow=function(){updateLearningStep(2);playAudio(0.7);};

/* ---- Rhythm Mode (works with any day's sentences) ---- */
let rhythmTimers=[];
window.rhythmPlay=function(){
  const s=getSentences()[idx];
  if(!s)return;
  // Cancel any running rhythm animation
  rhythmTimers.forEach(t=>clearTimeout(t));
  rhythmTimers=[];
  playAudio(0.85);
  const words=document.querySelectorAll('.stress-word');
  if(!words.length)return;
  const stressRow=document.querySelector('.stress-row');
  if(!stressRow)return;
  stressRow.querySelectorAll('.rhythm-ball').forEach(b=>b.remove());
  // Pre-calculate positions to avoid layout thrashing during animation
  const positions=[];
  const parentRect=stressRow.getBoundingClientRect();
  words.forEach(w=>{
    const r=w.getBoundingClientRect();
    positions.push(r.left-parentRect.left+r.width/2-6);
  });
  const ball=document.createElement('div');
  ball.className='rhythm-ball';
  stressRow.style.position='relative';
  stressRow.appendChild(ball);
  let elapsed=0;
  s.words.forEach((w,i)=>{
    const stressed=s.stress[i]>=0.8;
    const wordTime=stressed?280:180;
    const tid=setTimeout(()=>{
      requestAnimationFrame(()=>{
        const wordEl=words[i];
        if(!wordEl||!ball.parentNode)return;
        ball.style.left=positions[i]+'px';
        ball.style.top='-16px';
        ball.className='rhythm-ball'+(stressed?' big':'');
        ball.style.animation='none';
        void ball.offsetWidth;
        ball.style.animation=(stressed?'ballBounceBig':'ballBounce')+' '+(stressed?'0.35s':'0.25s')+' ease';
        words.forEach(w=>w.classList.remove('active'));
        wordEl.classList.add('active');
      });
    },elapsed);
    rhythmTimers.push(tid);
    elapsed+=wordTime;
  });
  const cleanupTid=setTimeout(()=>{if(ball.parentNode)ball.remove();words.forEach(w=>w.classList.remove('active'));},elapsed+500);
  rhythmTimers.push(cleanupTid);
};

/* ---- Record & Compare ---- */
/* --- WAV encoder for Safari fallback --- */
function encodeWAV(samples,sampleRate){
  const buf=new ArrayBuffer(44+samples.length*2);
  const v=new DataView(buf);
  function ws(o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}
  ws(0,'RIFF');v.setUint32(4,36+samples.length*2,true);ws(8,'WAVE');
  ws(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);
  v.setUint32(24,sampleRate,true);v.setUint32(28,sampleRate*2,true);
  v.setUint16(32,2,true);v.setUint16(34,16,true);
  ws(36,'data');v.setUint32(40,samples.length*2,true);
  for(let i=0;i<samples.length;i++){const s=Math.max(-1,Math.min(1,samples[i]));v.setInt16(44+i*2,s<0?s*0x8000:s*0x7FFF,true);}
  return new Blob([v],{type:'audio/wav'});
}

/* --- Fallback recorder state (AudioContext + ScriptProcessor for old Safari) --- */
let _fallbackStream=null,_fallbackSource=null,_fallbackProcessor=null,_fallbackChunks=[];

function getRecMimeType(){
  if(typeof MediaRecorder==='undefined')return'';
  const types=['audio/webm;codecs=opus','audio/webm','audio/mp4','audio/aac','audio/ogg;codecs=opus'];
  for(const t of types){if(MediaRecorder.isTypeSupported(t))return t;}
  return'';
}

async function startRecording(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true,latency:0}});
    recChunks=[];
    recSentenceId=getSentences()[idx].id;
    recScore=null;recUserDur=null;recNativeDur=null;_userAudioBuf=null;_nativeAudioBuf=null;

    const mimeType=getRecMimeType();
    const useMediaRecorder=typeof MediaRecorder!=='undefined'&&mimeType!=='';

    if(useMediaRecorder){
      /* --- MediaRecorder path (Chrome, Firefox, Safari 14.5+) --- */
      const opts={audioBitsPerSecond:64000};
      if(mimeType)opts.mimeType=mimeType;
      mediaRecorder=new MediaRecorder(stream,opts);
      mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recChunks.push(e.data);};
      mediaRecorder.onstop=async()=>{
        stream.getTracks().forEach(t=>t.stop());
        recBlob=new Blob(recChunks,{type:mimeType||'audio/webm'});
        if(recUrl)URL.revokeObjectURL(recUrl);
        recUrl=URL.createObjectURL(recBlob);
        isRecording=false;
        if(recTimerId){clearInterval(recTimerId);recTimerId=null;}
        const btn=document.getElementById('recBtn');
        if(btn){btn.classList.remove('recording');btn.innerHTML='&#9679; ÂΩïÈü≥';}
        renderRecCompare();
        await analyzeAndScore();
      };
      mediaRecorder.start(50);
    }else{
      /* --- AudioContext + ScriptProcessor fallback (old Safari) --- */
      const actx=getAudioCtx();
      _fallbackStream=stream;
      _fallbackSource=actx.createMediaStreamSource(stream);
      _fallbackProcessor=actx.createScriptProcessor(2048,1,1);
      _fallbackChunks=[];
      _fallbackProcessor.onaudioprocess=e=>{
        if(!isRecording)return;
        const input=e.inputBuffer.getChannelData(0);
        _fallbackChunks.push(new Float32Array(input));
      };
      _fallbackSource.connect(_fallbackProcessor);
      _fallbackProcessor.connect(actx.destination);
      mediaRecorder={state:'recording',stop:function(){
        _fallbackProcessor.disconnect();_fallbackSource.disconnect();
        stream.getTracks().forEach(t=>t.stop());
        const totalLen=_fallbackChunks.reduce((a,c)=>a+c.length,0);
        const merged=new Float32Array(totalLen);
        let offset=0;
        for(const chunk of _fallbackChunks){merged.set(chunk,offset);offset+=chunk.length;}
        recBlob=encodeWAV(merged,actx.sampleRate);
        if(recUrl)URL.revokeObjectURL(recUrl);
        recUrl=URL.createObjectURL(recBlob);
        isRecording=false;
        if(recTimerId){clearInterval(recTimerId);recTimerId=null;}
        const btn=document.getElementById('recBtn');
        if(btn){btn.classList.remove('recording');btn.innerHTML='&#9679; ÂΩïÈü≥';}
        _fallbackStream=null;_fallbackSource=null;_fallbackProcessor=null;_fallbackChunks=[];
        renderRecCompare();
        analyzeAndScore();
      }};
    }

    isRecording=true;
    recStartTime=Date.now();
    const btn=document.getElementById('recBtn');
    if(btn){btn.classList.add('recording');btn.innerHTML='&#9632; <span class="rec-timer">0.0s</span>';}
    recTimerId=setInterval(()=>{
      const el=document.querySelector('.rec-timer');
      if(el)el.textContent=((Date.now()-recStartTime)/1000).toFixed(1)+'s';
    },100);
    setTimeout(()=>{if(isRecording)stopRecording();},8000);
  }catch(e){
    console.error('Mic error:',e);
    alert('Êó†Ê≥ï‰ΩøÁî®È∫¶ÂÖãÈ£éÔºåËØ∑ÂÖÅËÆ∏È∫¶ÂÖãÈ£éÊùÉÈôêÂêéÈáçËØï„ÄÇ');
  }
}

function stopRecording(){
  if(mediaRecorder){
    if(typeof mediaRecorder.stop==='function')mediaRecorder.stop();
  }
  isRecording=false;
  if(recTimerId){clearInterval(recTimerId);recTimerId=null;}
  const btn=document.getElementById('recBtn');
  if(btn){btn.classList.remove('recording');btn.innerHTML='&#9679; ÂΩïÈü≥';}
}

window.toggleRecord=async function(){
  updateLearningStep(3);
  if(isRecording)stopRecording();
  else await startRecording();
};

function detectPauses(audioBuf){
  const data=audioBuf.getChannelData(0);
  const sr=audioBuf.sampleRate;
  const winSize=Math.floor(sr*0.05);
  const minSilence=Math.floor(sr*0.2);
  let silent=0,pauses=0,inSilence=false;
  for(let i=0;i<data.length;i+=winSize){
    let sum=0;const end=Math.min(i+winSize,data.length);
    for(let j=i;j<end;j++)sum+=Math.abs(data[j]);
    const avg=sum/(end-i);
    if(avg<0.015){silent+=(end-i);if(silent>=minSilence&&!inSilence){pauses++;inSilence=true;}}
    else{silent=0;inSilence=false;}
  }
  return pauses;
}

function drawWaveform(audioBuf,canvasId){
  const canvas=document.getElementById(canvasId);
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=canvas.offsetWidth*dpr;
  const H=canvas.offsetHeight*dpr;
  canvas.width=W;canvas.height=H;
  ctx.clearRect(0,0,W,H);
  const data=audioBuf.getChannelData(0);
  const bars=40;
  const barW=W/bars;
  const samplesPerBar=Math.floor(data.length/bars);
  const color=canvasId==='waveNative'?'#6366f1':'#10b981';
  for(let i=0;i<bars;i++){
    let sum=0;
    for(let j=0;j<samplesPerBar;j++)sum+=Math.abs(data[i*samplesPerBar+j]||0);
    const avg=sum/samplesPerBar;
    const barH=Math.max(2,avg*H*3.5);
    const x=i*barW+1;
    const y=(H-barH)/2;
    ctx.fillStyle=color;
    ctx.beginPath();
    if(ctx.roundRect){ctx.roundRect(x,y,barW-2,barH,2);ctx.fill();}
    else ctx.fillRect(x,y,barW-2,barH);
  }
}

let _analyzing=false;
async function analyzeAndScore(){
  if(!recBlob||_analyzing)return;
  _analyzing=true;
  try{
    const actx=getAudioCtx();
    let userAudio=null;
    try{
      const userBuf=await recBlob.arrayBuffer();
      userAudio=await actx.decodeAudioData(userBuf.slice(0));
      _userAudioBuf=userAudio;recUserDur=userAudio.duration;
      drawWaveform(userAudio,'waveUser');
    }catch(de){
      console.warn('decodeAudioData failed, continuing with AI analysis:',de);
      // Estimate duration from blob size (webm/opus ~16kbps)
      if(!recUserDur)recUserDur=Math.max(1,recBlob.size/2000);
    }
    const s=getSentences()[idx];
    const id=String(s.id).padStart(2,'0');

    // Try AI engine analysis
    if(aiEngine){
      try{
        const nativeResp=await fetch('audio/'+id+'.mp3');
        let nativeBlob=null;
        if(nativeResp.ok) nativeBlob=await nativeResp.blob();

        const result=await aiEngine.analyzeRecording(recBlob, nativeBlob, {
          words: s.words,
          stress: s.stress,
          sentenceId: s.id,
          dayNum: currentDay
        });

        if(nativeBlob){
          const natBuf=await nativeBlob.arrayBuffer();
          const natAudio=await actx.decodeAudioData(natBuf.slice(0));
          _nativeAudioBuf=natAudio;recNativeDur=natAudio.duration;
          drawWaveform(natAudio,'waveNative');
        }

        recScore=result.rhythm.overall;
        renderAIScore(result);
        updateLearningStep(4);
        saveRecording(s.id,recScore);

        // Update weakness profiler (scores must be 0-1 range, not 0-100)
        weaknessProfiler.recordAttempt({
          scores: {
            stress: (result.rhythm.stressAccuracy || 0) / 100,
            intonation: (result.rhythm.intonation || 0) / 100,
            linking: (result.rhythm.connectedSpeech || 0) / 100,
            speed: (result.rhythm.timingRatio || 0) / 100,
            vowels: 0.7,
            consonants: 0.7
          }
        });

        // Update coach panel if open
        if(document.getElementById('coachPanel').classList.contains('open')){
          CoachPanel.render();
        }

        _analyzing=false;
        return;
      }catch(e){console.warn('AI analysis fallback:',e);}
    }

    // Fallback to basic analysis
    let nativeDur=s.words.length*0.3;
    let nativePauses=Math.max(0,Math.floor(s.words.length/5)-1);
    try{
      const resp=await fetch('audio/'+id+'.mp3');
      if(resp.ok){
        const natBuf=await resp.arrayBuffer();
        const natAudio=await actx.decodeAudioData(natBuf.slice(0));
        nativeDur=natAudio.duration;
        nativePauses=detectPauses(natAudio);
        _nativeAudioBuf=natAudio;recNativeDur=nativeDur;
        drawWaveform(natAudio,'waveNative');
      }
    }catch{}
    const userDur=userAudio?userAudio.duration:(recUserDur||3);recUserDur=userDur;
    const durRatio=userDur/Math.max(nativeDur,0.5);
    const durScore=Math.max(0,60*(1-Math.abs(durRatio-1)*2));
    const userPauses=userAudio?detectPauses(userAudio):0;
    const pauseDiff=Math.abs(userPauses-nativePauses);
    const pauseScore=Math.max(0,40-pauseDiff*12);
    const totalScore=Math.round(Math.min(100,Math.max(0,durScore+pauseScore)));
    recScore=totalScore;
    renderScoreRing(totalScore,durScore,pauseScore,userDur,nativeDur);
    updateLearningStep(4);
    saveRecording(s.id,recScore);
  }catch(e){console.error('Analysis error:',e);}
  finally{_analyzing=false;}
}

function renderScoreRing(score,dS,pS,uDur,nDur){
  const el=document.getElementById('scoreRing');
  if(!el)return;
  const color=score>=70?'var(--ok)':score>=40?'var(--acc)':'var(--red)';
  const C=2*Math.PI*34;
  const offset=C-(score/100)*C;
  el.innerHTML=`
    <svg class="score-ring-svg" width="80" height="80" viewBox="0 0 80 80">
      <circle class="score-ring-bg" cx="40" cy="40" r="34"/>
      <circle class="score-ring-fg" cx="40" cy="40" r="34" stroke="${color}"
        stroke-dasharray="${C}" stroke-dashoffset="${C}"/>
    </svg>
    <span class="score-num" style="color:${color}">${score}</span>`;
  const detail=document.getElementById('scoreDetail');
  if(detail){
    const durPct=Math.round(Math.max(0,Math.min(100,dS/60*100)));
    const pPct=Math.round(Math.max(0,Math.min(100,pS/40*100)));
    detail.innerHTML=`Êó∂ÈïøÔºö${uDur?uDur.toFixed(1):'?'}Áßí vs ${nDur?nDur.toFixed(1):'?'}Áßí (${durPct}%) ¬∑ ËäÇÂ•èÔºö${pPct}%`;
  }
  setTimeout(()=>{
    const fg=el.querySelector('.score-ring-fg');
    if(fg)fg.setAttribute('stroke-dashoffset',offset);
  },50);
}

let _savingRecording=false;
function saveRecording(sid,score){
  if(!recBlob||_savingRecording)return;
  _savingRecording=true;
  const reader=new FileReader();
  reader.onload=()=>{
    _savingRecording=false;
    const key=`re-rec-${sid}`;
    let hist=JSON.parse(localStorage.getItem(key)||'[]');
    hist.unshift({b64:reader.result,score,ts:Date.now()});
    if(hist.length>3)hist=hist.slice(0,3);
    try{localStorage.setItem(key,JSON.stringify(hist));}
    catch(e){
      if(hist.length>1){hist=hist.slice(0,1);try{localStorage.setItem(key,JSON.stringify(hist));}catch{}}
    }
    // Only update history list, do NOT call renderRecCompare to avoid infinite loop
    const histList=document.querySelector('.rec-history-list');
    if(histList){
      let hhtml='';
      hist.forEach((h,i)=>{
        const c=h.score>=70?'var(--ok)':h.score>=40?'var(--acc)':'var(--red)';
        const t=new Date(h.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        hhtml+=`<div class="rec-hist-item" onclick="window.playHistRec(${i})">
          <span class="rec-hist-score" style="color:${c}">${h.score}</span>
          <span class="rec-hist-play">‚ñ∂</span>
          <span class="rec-hist-time">${t}</span>
        </div>`;
      });
      histList.innerHTML=hhtml;
    }
  };
  reader.onerror=()=>{_savingRecording=false;};
  reader.readAsDataURL(recBlob);
}

function renderRecCompare(){
  const el=document.getElementById('recCompare');
  if(!el)return;
  const s=getSentences()[idx];
  if(!s){el.innerHTML='';return;}
  const hasRec=recBlob&&recSentenceId===s.id;
  const history=getRecHistory(s.id);
  if(!hasRec&&history.length===0){el.innerHTML='';return;}
  let html='<div class="compare-area">';
  html+='<div class="compare-label">ÂΩïÈü≥ÂØπÊØî</div>';
  if(hasRec){
    html+=`<div class="compare-btns">
      <button class="compare-btn native" id="cmpNative" onclick="window.playNative()">&#9654; Ê†áÂáÜÂèëÈü≥</button>
      <button class="compare-btn user" id="cmpUser" onclick="window.playUser()">&#9679; ‰Ω†ÁöÑÂèëÈü≥</button>
    </div>
    <div class="waveform-wrap">
      <div class="waveform-box"><label>Ê†áÂáÜÂèëÈü≥</label><canvas class="waveform-canvas" id="waveNative"></canvas></div>
      <div class="waveform-box"><label>‰Ω†ÁöÑÂèëÈü≥</label><canvas class="waveform-canvas" id="waveUser"></canvas></div>
    </div>
    <div class="score-wrap">
      <div class="score-ring-container" id="scoreRing"></div>
      <div class="score-label">ËäÇÂ•èÂåπÈÖç</div>
      <div class="score-detail" id="scoreDetail"></div>
    </div>`;
  }
  if(history.length>0){
    html+='<div class="rec-history"><div class="rec-history-label">ÊúÄËøëÂΩïÈü≥</div><div class="rec-history-list">';
    history.forEach((h,i)=>{
      const c=h.score>=70?'var(--ok)':h.score>=40?'var(--acc)':'var(--red)';
      const t=new Date(h.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      html+=`<div class="rec-hist-item" onclick="window.playHistRec(${i})">
        <span class="rec-hist-score" style="color:${c}">${h.score}</span>
        <span class="rec-hist-play">‚ñ∂</span>
        <span class="rec-hist-time">${t}</span>
      </div>`;
    });
    html+='</div></div>';
  }
  html+='</div>';
  el.innerHTML=html;
  // Re-draw cached waveforms (canvas elements were just rebuilt by innerHTML)
  if(hasRec&&_userAudioBuf){
    setTimeout(()=>{
      drawWaveform(_userAudioBuf,'waveUser');
      if(_nativeAudioBuf)drawWaveform(_nativeAudioBuf,'waveNative');
    },30);
  }
  if(hasRec&&recScore!==null){
    renderScoreRing(recScore,0,0,recUserDur||0,recNativeDur||0);
  }
}

let cmpAudio=null;
window.playNative=function(){
  if(cmpAudio){cmpAudio.pause();cmpAudio=null;}
  playAudio(1);
};
window.playUser=function(){
  if(!recUrl)return;
  if(cmpAudio){cmpAudio.pause();cmpAudio=null;}
  cmpAudio=new Audio(recUrl);
  const btn=document.getElementById('cmpUser');
  if(btn)btn.classList.add('cplaying');
  cmpAudio.onended=()=>{if(btn)btn.classList.remove('cplaying');cmpAudio=null;};
  cmpAudio.play().catch(e=>{console.warn('playUser failed:',e);if(btn)btn.classList.remove('cplaying');cmpAudio=null;});
};
window.playHistRec=function(i){
  const s=getSentences()[idx];
  const hist=getRecHistory(s.id);
  if(!hist[i])return;
  if(cmpAudio){cmpAudio.pause();cmpAudio=null;}
  cmpAudio=new Audio(hist[i].b64);
  cmpAudio.onended=()=>{cmpAudio=null;};
  cmpAudio.play();
};

/* ---- Navigation (debounced) ---- */
let navLock=false;
window.go=function(dir){
  if(navLock)return;
  navLock=true;
  const sents=getSentences();
  if(!sents.length){navLock=false;return;}
  const card=$('#card');
  card.classList.add(dir>0?'slide-l':'slide-r');
  setTimeout(()=>{
    idx=Math.max(0,Math.min(sents.length-1,idx+dir));
    card.classList.remove('slide-l','slide-r');
    render();
    navLock=false;
  },220);
};
let sx=0,sy=0,swiping=false;
document.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;swiping=true;},{passive:true});
document.addEventListener('touchend',e=>{
  if(!swiping)return;
  swiping=false;
  const dx=e.changedTouches[0].clientX-sx;
  const dy=e.changedTouches[0].clientY-sy;
  if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*1.5){dx<0?go(1):go(-1);}
},{passive:true});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){if($('#reviewOverlay').classList.contains('active')){SR.close();return;}if($('#challengeOverlay').classList.contains('active')){DailyChallenge.close();return;}}
  if($('#quizOverlay').classList.contains('active')||$('#reviewOverlay').classList.contains('active')||$('#challengeOverlay').classList.contains('active'))return;
  if(e.key==='ArrowRight')go(1);
  if(e.key==='ArrowLeft')go(-1);
  if(e.key===' '){e.preventDefault();window.speak();}
});

/* ---- XP System ---- */
function getXP(){return parseInt(localStorage.getItem('re-xp')||'0');}
function addXP(n){const x=getXP()+n;try{localStorage.setItem('re-xp',String(x));}catch{}$('#xpNum').textContent=x;return x;}
function updateXP(){$('#xpNum').textContent=getXP();}

/* ---- Quiz Engine (per-day, saves best score) ---- */
const Quiz={
  questions:[],current:0,score:0,answered:false,results:[],

  generate(){
    const sents=getSentences();
    const p=getProgress();
    const pool=p.learned.length>=5?sents.filter(s=>p.learned.includes(s.id)):sents.slice(0,10);
    if(pool.length<4)return false;
    this.questions=[];this.current=0;this.score=0;this.results=[];
    const shuffled=[...pool].sort(()=>Math.random()-.5).slice(0,10);
    for(const s of shuffled){
      const qType=Math.random();
      if(qType<0.33){
        const wrong=pool.filter(x=>x.id!==s.id).sort(()=>Math.random()-.5).slice(0,3).map(x=>x.cn);
        const opts=[s.cn,...wrong].sort(()=>Math.random()-.5);
        this.questions.push({type:'meaning',prompt:s.text,hint:'ËøôÂè•ËØùÊòØ‰ªÄ‰πàÊÑèÊÄùÔºü',options:opts,answer:s.cn,sentenceId:s.id});
      }else if(qType<0.66){
        const wrong=pool.filter(x=>x.id!==s.id).sort(()=>Math.random()-.5).slice(0,3).map(x=>x.text);
        const opts=[s.text,...wrong].sort(()=>Math.random()-.5);
        this.questions.push({type:'scene',prompt:s.cn,hint:'ÂØπÂ∫îÂì™‰∏™Ëã±ËØ≠Âè•Â≠êÔºü',options:opts,answer:s.text,sentenceId:s.id});
      }else{
        const stressedWords=s.words.filter((_,i)=>s.stress[i]>=0.8);
        if(stressedWords.length===0)continue;
        const target=stressedWords[Math.floor(Math.random()*stressedWords.length)];
        // Fix: use index-aware filter to handle duplicate words correctly
        const wrong=s.words.filter((_,i)=>s.words[i]!==target&&s.stress[i]<0.5);
        // Deduplicate wrong options
        const uniqueWrong=[...new Set(wrong)].slice(0,3);
        if(uniqueWrong.length<2)continue;
        const opts=[target,...uniqueWrong].sort(()=>Math.random()-.5);
        this.questions.push({type:'stress',prompt:s.text,hint:'Âì™‰∏™ËØçÁöÑÈáçÈü≥ÊúÄÂº∫Ôºü',options:opts,answer:target,sentenceId:s.id});
      }
    }
    return this.questions.length>=3;
  },

  start(){
    if(!this.generate()){alert('ÂÖàÂ≠¶‰ºöËá≥Â∞ë5‰∏™Âè•Â≠êÂÜçÊµãÈ™åÔºÅ');return;}
    this._prevFocus=document.activeElement;
    $('#quizOverlay').classList.add('active');
    this.renderQuestion();
    // Move focus into quiz for accessibility
    const firstOpt=$('#quizOverlay .quiz-opt');
    if(firstOpt)setTimeout(()=>firstOpt.focus(),100);
  },

  renderQuestion(){
    const q=this.questions[this.current];
    this.answered=false;
    $('#quizProgress').innerHTML=this.questions.map((_,i)=>{
      let cls='quiz-pip';
      if(i<this.current)cls+=this.results[i]?' done':' wrong';
      else if(i===this.current)cls+=' current';
      return`<div class="${cls}"></div>`;
    }).join('');
    $('#quizContent').innerHTML=`
      <div class="quiz-q">${q.prompt}</div>
      <div class="quiz-hint">${q.hint}</div>
      <div class="quiz-opts" role="radiogroup">${q.options.map((o,i)=>
        `<button class="quiz-opt" data-idx="${i}" tabindex="0" role="radio" aria-checked="false" type="button">${o}</button>`
      ).join('')}</div>
      <div id="quizFeedback"></div>
      <button class="quiz-next-btn" id="quizNextBtn" style="display:none" onclick="Quiz.next()">ÁªßÁª≠</button>
    `;
    // Bind click handlers directly (more reliable on mobile than inline onclick)
    document.querySelectorAll('#quizContent .quiz-opt').forEach((el,i)=>{
      el.addEventListener('click',()=>Quiz.pick(i));
      el.addEventListener('touchend',(e)=>{e.preventDefault();Quiz.pick(i);});
    });
  },

  pick(i){
    if(this.answered)return;
    this.answered=true;
    const q=this.questions[this.current];
    const picked=q.options[i];
    const correct=picked===q.answer;
    this.results.push(correct);
    if(correct)this.score++;
    else if(typeof SR!=='undefined')SR.addCard(q.sentenceId,currentDay);
    document.querySelectorAll('.quiz-opt').forEach((el,j)=>{
      if(q.options[j]===q.answer)el.classList.add('correct');
      else if(j===i&&!correct)el.classList.add('wrong');
    });
    const fb=$('#quizFeedback');
    fb.className='quiz-feedback '+(correct?'right':'wrong');
    fb.textContent=correct?['ÂÆåÁæéÔºÅ','Á≠îÂØπ‰∫ÜÔºÅ','Â§™Ê£í‰∫ÜÔºÅ'][Math.floor(Math.random()*3)]:
      `Á≠îÈîô‰∫Ü‚Äî‚ÄîÊ≠£Á°ÆÁ≠îÊ°àÔºö${q.answer}`;
    $('#quizNextBtn').style.display='block';
  },

  next(){
    this.current++;
    if(this.current>=this.questions.length){this.showResults();return;}
    this.renderQuestion();
  },

  showResults(){
    const pct=Math.round(this.score/this.questions.length*100);
    const xpEarned=this.score*10;
    addXP(xpEarned);
    // Save best quiz score for current day & check unlocks
    const unlockNames=['Á¨¨2Â§©ÔºöË∞àÂà§','Á¨¨3Â§©ÔºöÈ¢ÜÂØºÂäõ','Á¨¨4Â§©Ôºö‰∫ßÂìÅ/ÊäÄÊúØ','Á¨¨5Â§©ÔºöÂÜ≤Á™ÅËß£ÂÜ≥','Á¨¨6Â§©ÔºöÁ§æ‰∫§ÁΩëÁªú','Á¨¨7Â§©ÔºöÂç±Êú∫Ê≤üÈÄö','Á¨¨8Â§©ÔºöÈù¢ËØï','Á¨¨9Â§©ÔºöÊºîËÆ≤','Á¨¨10Â§©ÔºöË∑®ÊñáÂåñ','Á¨¨11Â§©ÔºöËøúÁ®ãÂ∑•‰Ωú','Á¨¨12Â§©ÔºöÈîÄÂîÆ','Á¨¨13Â§©ÔºöÂÖ¨ÂºÄÊºîËÆ≤','Á¨¨14Â§©ÔºöAI‰∏éÊú™Êù•','Á¨¨15Â§©+ÔºöÊó†ÈôêÁªÉ‰π†'];
    const unlocksBefore=[];
    for(let u=2;u<=15;u++)unlocksBefore.push(isDayUnlocked(u));
    const p=getProgress();
    p.quizBest=Math.max(p.quizBest||0,pct);
    updateStreakIfNeeded(p);
    saveProgress(p);
    const unlocksAfter=[];
    for(let u=2;u<=15;u++)unlocksAfter.push(isDayUnlocked(u));
    let unlockHtml='';
    for(let u=0;u<14;u++){if(!unlocksBefore[u]&&unlocksAfter[u])unlockHtml+=`<div style="text-align:center;margin:16px 0;padding:16px;background:rgba(16,185,129,.1);border-radius:12px;font-size:15px;color:var(--ok);font-weight:700">* ${unlockNames[u]} Â∑≤Ëß£ÈîÅÔºÅ</div>`;}
    $('#quizContent').innerHTML=`
      <div class="quiz-score">
        <div class="quiz-score-num">${pct}%</div>
        <div class="quiz-score-label">${this.score}/${this.questions.length} Á≠îÂØπ</div>
        <div class="quiz-xp">+${xpEarned} XP</div>
      </div>
      ${unlockHtml}
      <button class="quiz-next-btn" onclick="Quiz.close()" style="margin-top:20px">ÂÆåÊàê</button>
    `;
    $('#quizProgress').innerHTML=this.questions.map((_,i)=>{
      return`<div class="quiz-pip${this.results[i]?' done':' wrong'}"></div>`;
    }).join('');
  },

  close(){
    $('#quizOverlay').classList.remove('active');
    this.questions=[];this.current=0;this.score=0;this.results=[];
    render();
    if(this._prevFocus&&this._prevFocus.focus)this._prevFocus.focus();
  }
};
window.Quiz=Quiz;

/* ---- Spaced Repetition (SR) ---- */
const SR={
  KEY:'sr_cards',
  _queue:[],_currentIdx:0,_revealed:false,_audio:null,

  getCards(){try{return JSON.parse(localStorage.getItem(this.KEY)||'[]');}catch{return[];}},
  saveCards(cards){try{localStorage.setItem(this.KEY,JSON.stringify(cards));}catch(e){console.warn('SR save failed',e);}},

  addCard(sentenceId,dayNum){
    const cards=this.getCards();
    const d=dayNum||currentDay;
    if(cards.find(c=>c.sentenceId===sentenceId&&c.dayNum===d))return;
    const now=Date.now();
    cards.push({sentenceId,dayNum:d,lastReview:now,interval:60000,easeFactor:2.5,dueDate:now});
    this.saveCards(cards);
  },

  getDueCards(){const now=Date.now();return this.getCards().filter(c=>c.dueDate<=now);},
  getDueCount(){return this.getDueCards().length;},

  rate(sentenceId,dayNum,rating){
    const cards=this.getCards();
    const card=cards.find(c=>c.sentenceId===sentenceId&&c.dayNum===dayNum);
    if(!card)return;
    const now=Date.now();
    card.lastReview=now;
    switch(rating){
      case'again':card.interval=60000;card.easeFactor=Math.max(1.3,card.easeFactor-0.2);break;
      case'hard':card.interval=Math.round(card.interval*1.2);card.easeFactor=Math.max(1.3,card.easeFactor-0.1);break;
      case'good':card.interval=Math.round(card.interval*card.easeFactor);break;
      case'easy':card.interval=Math.round(card.interval*card.easeFactor*1.3);card.easeFactor+=0.1;break;
    }
    card.dueDate=now+card.interval;
    this.saveCards(cards);
  },

  findSentence(card){
    if(card.dayNum<=14)return(ALL_DAYS[card.dayNum-1]||[]).find(s=>s.id===card.sentenceId);
    return(getGeneratedDay(card.dayNum).sentences||[]).find(s=>s.id===card.sentenceId);
  },

  _formatInterval(ms){
    if(ms<60000)return'<1ÂàÜ';if(ms<3600000)return Math.round(ms/60000)+'ÂàÜ';
    if(ms<86400000)return Math.round(ms/3600000)+'Êó∂';return Math.round(ms/86400000)+'Â§©';
  },

  start(){
    this._queue=this.getDueCards();
    if(!this._queue.length){alert('Ê≤°ÊúâÈúÄË¶ÅÂ§ç‰π†ÁöÑÂç°ÁâáÔºÅ');return;}
    this._currentIdx=0;this._revealed=false;
    document.getElementById('reviewOverlay').classList.add('active');
    this.renderCard();
  },

  renderCard(){
    const card=this._queue[this._currentIdx];
    if(!card){this.showComplete();return;}
    const sentence=this.findSentence(card);
    if(!sentence){this._currentIdx++;this.renderCard();return;}
    const total=this._queue.length,current=this._currentIdx+1;
    const dots=sentence.words.map((w,i)=>{
      const stressed=sentence.stress[i]>=0.8,mid=sentence.stress[i]>=0.4&&sentence.stress[i]<0.8;
      const size=stressed?36:mid?22:14,cls=stressed?'big':'small',lblCls=stressed?'loud':'';
      return`<div class="stress-word"><div class="stress-dot ${cls}" style="width:${size}px;height:${size}px"></div><span class="stress-label ${lblCls}">${stressed?w.toUpperCase():w}</span></div>`;
    }).join('');
    let html=`
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <button class="nav-btn" onclick="SR.close()" aria-label="Close review" style="font-size:16px">‚úï</button>
        <span style="color:var(--dim);font-size:13px">${current} / ${total} ÂæÖÂ§ç‰π†</span>
      </div>
      <div style="text-align:center;margin-bottom:20px">
        <div class="cat">Á¨¨${card.dayNum}Â§© ¬∑ Â§ç‰π†</div>
        <div class="stress-row">${dots}</div>
        <div class="sentence">${sentence.text}</div>
        <div class="ipa">${sentence.ipa}</div>
        <div class="audio-row" style="margin-top:16px">
          <button class="audio-btn primary" onclick="SR.playAudio(1)" aria-label="Âê¨‰∏ÄÂê¨">‚ñ∂ Âê¨‰∏ÄÂê¨</button>
          <button class="audio-btn slow" onclick="SR.playAudio(0.7)" aria-label="ÊÖ¢ÈÄü">0.7x</button>
        </div>
      </div>`;
    if(this._revealed){
      html+=`
        <div style="text-align:center;margin:20px 0">
          <div class="cn-helper">${sentence.cn}</div>
          <div style="margin-top:12px;font-size:13px;color:var(--dim)">${sentence.meaning}</div>
        </div>
        <div style="text-align:center;margin-top:12px;font-size:13px;color:var(--dim);margin-bottom:8px">‰Ω†ËÆ∞ÂæóÂ§öÂ•ΩÔºü</div>
        <div class="sr-rating-row">
          <button class="sr-rate-btn sr-again" onclick="SR.rateAndNext('again')">ÂÜçÊù•<br><span>1ÂàÜÈíü</span></button>
          <button class="sr-rate-btn sr-hard" onclick="SR.rateAndNext('hard')">Âõ∞Èöæ<br><span>${this._formatInterval(card.interval*1.2)}</span></button>
          <button class="sr-rate-btn sr-good" onclick="SR.rateAndNext('good')">ËøòË°å<br><span>${this._formatInterval(card.interval*card.easeFactor)}</span></button>
          <button class="sr-rate-btn sr-easy" onclick="SR.rateAndNext('easy')">ÁÆÄÂçï<br><span>${this._formatInterval(card.interval*card.easeFactor*1.3)}</span></button>
        </div>`;
    }else{
      html+=`<button class="quiz-next-btn" onclick="SR.reveal()" style="margin-top:20px">ÊòæÁ§∫Á≠îÊ°à</button>`;
    }
    document.getElementById('reviewContent').innerHTML=html;
  },

  playAudio(rate){
    if(this._audio){this._audio.pause();this._audio=null;}
    if(typeof speechSynthesis!=='undefined')speechSynthesis.cancel();
    const card=this._queue[this._currentIdx];if(!card)return;
    const sentence=this.findSentence(card);if(!sentence)return;
    const id=String(sentence.id).padStart(2,'0');
    this._audio=new Audio('audio/'+id+'.mp3');
    this._audio.playbackRate=rate||1;
    this._audio.onerror=()=>{
      if(typeof speechSynthesis!=='undefined'){
        const u=new SpeechSynthesisUtterance(sentence.text);
        u.lang='en-US';u.rate=(rate||1)*0.85;speechSynthesis.speak(u);
      }
    };
    this._audio.play().catch(()=>{if(this._audio&&this._audio.onerror)this._audio.onerror();});
  },

  reveal(){this._revealed=true;this.renderCard();},

  rateAndNext(rating){
    const card=this._queue[this._currentIdx];
    if(card)this.rate(card.sentenceId,card.dayNum,rating);
    this._currentIdx++;this._revealed=false;
    if(this._audio){this._audio.pause();this._audio=null;}
    this.renderCard();
  },

  showComplete(){
    document.getElementById('reviewContent').innerHTML=`
      <div style="text-align:center;padding:60px 20px">
        <div style="font-size:48px;margin-bottom:16px">üéâ</div>
        <div style="font-size:24px;font-weight:900;margin-bottom:8px">ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ</div>
        <div style="color:var(--dim);margin-bottom:24px">Ê≤°ÊúâÊõ¥Â§öÈúÄË¶ÅÂ§ç‰π†ÁöÑÂç°Áâá‰∫Ü</div>
        <button class="quiz-next-btn" onclick="SR.close()">ËøîÂõû</button>
      </div>`;
  },

  close(){
    document.getElementById('reviewOverlay').classList.remove('active');
    if(this._audio){this._audio.pause();this._audio=null;}
    render();
  }
};
window.SR=SR;

/* ---- Daily Challenge ---- */
const DailyChallenge={
  KEY_BEST:'dc_best',KEY_STREAK:'dc_streak',
  _questions:[],_current:0,_score:0,_timer:null,_timeLeft:90,_startTime:0,_results:[],_answered:false,

  _seedHash(str){let h=0;for(let i=0;i<str.length;i++)h=((h<<5)-h+str.charCodeAt(i))|0;return Math.abs(h);},
  _seededRng(seed){let s=seed||1;return function(){s=(s*16807)%2147483647;return(s-1)/2147483646;};},

  getAllSentences(){
    const all=[];
    for(let d=1;d<=14;d++){if(isDayUnlocked(d))ALL_DAYS[d-1].forEach(s=>all.push({...s,dayNum:d}));}
    for(let d=15;d<=20;d++){if(isDayUnlocked(d))getGeneratedDay(d).sentences.forEach(s=>all.push({...s,dayNum:d}));}
    return all;
  },

  generateQuestions(){
    const dateStr=new Date().toDateString();
    const seed=this._seedHash(dateStr);
    const rng=this._seededRng(seed);
    const allS=this.getAllSentences();
    if(allS.length<10)return false;
    const shuffled=[...allS];
    for(let i=shuffled.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]];}
    const selected=shuffled.slice(0,10);
    this._questions=[];
    for(const s of selected){
      const qType=rng();
      if(qType<0.5){
        const wrong=[...allS].filter(x=>x.id!==s.id||x.dayNum!==s.dayNum);
        for(let i=wrong.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[wrong[i],wrong[j]]=[wrong[j],wrong[i]];}
        const opts=[s.cn,...wrong.slice(0,3).map(x=>x.cn)];
        for(let i=opts.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[opts[i],opts[j]]=[opts[j],opts[i]];}
        this._questions.push({prompt:s.text,hint:'ËøôÂè•ËØùÊòØ‰ªÄ‰πàÊÑèÊÄùÔºü',options:opts,answer:s.cn,sentenceId:s.id,dayNum:s.dayNum});
      }else{
        const wrong=[...allS].filter(x=>x.id!==s.id||x.dayNum!==s.dayNum);
        for(let i=wrong.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[wrong[i],wrong[j]]=[wrong[j],wrong[i]];}
        const opts=[s.text,...wrong.slice(0,3).map(x=>x.text)];
        for(let i=opts.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[opts[i],opts[j]]=[opts[j],opts[i]];}
        this._questions.push({prompt:s.cn,hint:'ÂØπÂ∫îÂì™‰∏™Ëã±ËØ≠Âè•Â≠êÔºü',options:opts,answer:s.text,sentenceId:s.id,dayNum:s.dayNum});
      }
    }
    return this._questions.length>=3;
  },

  getBest(){return parseInt(localStorage.getItem(this.KEY_BEST)||'0');},
  getStreak(){try{return JSON.parse(localStorage.getItem(this.KEY_STREAK)||'{"count":0,"lastDate":null}');}catch{return{count:0,lastDate:null};}},

  start(){
    if(!this.generateQuestions()){alert('Âè•Â≠ê‰∏çÂ§üÔºÅËØ∑ÂÖàËß£ÈîÅÊõ¥Â§öÂ§©„ÄÇ');return;}
    this._current=0;this._score=0;this._timeLeft=90;this._results=[];this._answered=false;this._startTime=Date.now();
    document.getElementById('challengeOverlay').classList.add('active');
    this._startTimer();this.renderQuestion();
  },

  _startTimer(){
    if(this._timer)clearInterval(this._timer);
    this._timer=setInterval(()=>{
      this._timeLeft=Math.max(0,90-Math.floor((Date.now()-this._startTime)/1000));
      const el=document.getElementById('dcTimer');
      if(el){el.textContent=this._timeLeft+'s';el.style.color=this._timeLeft<=10?'var(--red)':this._timeLeft<=30?'var(--acc)':'var(--ok)';}
      const bar=document.getElementById('dcTimerBar');
      if(bar)bar.style.width=(this._timeLeft/90*100)+'%';
      if(this._timeLeft<=0){clearInterval(this._timer);this._timer=null;this.timeUp();}
    },250);
  },

  renderQuestion(){
    if(this._current>=this._questions.length){this.showResults();return;}
    const q=this._questions[this._current];this._answered=false;
    const total=this._questions.length,current=this._current+1;
    document.getElementById('challengeContent').innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <span style="color:var(--dim);font-size:13px">${current}/${total}</span>
        <div class="dc-timer-wrap"><span class="dc-timer" id="dcTimer">${this._timeLeft}s</span></div>
        <span style="color:var(--acc);font-size:13px;font-weight:700">ÂæóÂàÜÔºö${this._score}</span>
      </div>
      <div class="dc-timer-bar-wrap"><div class="dc-timer-bar" id="dcTimerBar" style="width:${this._timeLeft/90*100}%"></div></div>
      <div class="quiz-progress" style="margin-bottom:16px">${this._questions.map((_,i)=>{
        let cls='quiz-pip';if(i<this._current)cls+=this._results[i]?' done':' wrong';else if(i===this._current)cls+=' current';return'<div class="'+cls+'"></div>';
      }).join('')}</div>
      <div class="quiz-q">${q.prompt}</div>
      <div class="quiz-hint">${q.hint}</div>
      <div class="quiz-opts">${q.options.map((o,i)=>
        '<button class="quiz-opt" type="button" tabindex="0" data-idx="'+i+'">'+o+'</button>'
      ).join('')}</div>
      <div id="dcFeedback"></div>`;
    // Bind click handlers directly (more reliable on mobile than inline onclick)
    document.querySelectorAll('#challengeContent .quiz-opt').forEach((el,i)=>{
      el.addEventListener('click',()=>DailyChallenge.pick(i));
      el.addEventListener('touchend',(e)=>{e.preventDefault();DailyChallenge.pick(i);});
    });
  },

  pick(i){
    if(this._answered)return;this._answered=true;
    const q=this._questions[this._current],picked=q.options[i],correct=picked===q.answer;
    this._results.push(correct);
    if(correct){this._score+=100+this._timeLeft;}
    else{SR.addCard(q.sentenceId,q.dayNum);}
    document.querySelectorAll('#challengeContent .quiz-opt').forEach((el,j)=>{
      if(q.options[j]===q.answer)el.classList.add('correct');
      else if(j===i&&!correct)el.classList.add('wrong');
    });
    const fb=document.getElementById('dcFeedback');
    if(fb){fb.className='quiz-feedback '+(correct?'right':'wrong');fb.textContent=correct?'+'+(100+this._timeLeft)+' ÂàÜÔºÅ':'Á≠îÈîô‰∫Ü‚Äî‚Äî'+q.answer;}
    setTimeout(()=>{this._current++;this.renderQuestion();},800);
  },

  timeUp(){while(this._results.length<this._questions.length)this._results.push(false);this.showResults();},

  showResults(){
    if(this._timer){clearInterval(this._timer);this._timer=null;}
    const best=this.getBest(),isNewBest=this._score>best;
    if(isNewBest)try{localStorage.setItem(this.KEY_BEST,String(this._score));}catch{}
    const today=new Date().toDateString(),streakData=this.getStreak();
    if(streakData.lastDate!==today){
      const yesterday=new Date();yesterday.setDate(yesterday.getDate()-1);
      streakData.count=streakData.lastDate===yesterday.toDateString()?(streakData.count||0)+1:1;
      streakData.lastDate=today;
      try{localStorage.setItem(this.KEY_STREAK,JSON.stringify(streakData));}catch{}
    }
    const correctCount=this._results.filter(r=>r).length;
    const xpEarned=correctCount*15;addXP(xpEarned);
    document.getElementById('challengeContent').innerHTML=`
      <div style="text-align:center;padding:30px 0">
        <div style="font-size:48px;margin-bottom:12px">${isNewBest?'üèÜ':'‚ö°'}</div>
        <div style="font-size:48px;font-weight:900;background:linear-gradient(135deg,var(--acc),var(--ok));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px">${this._score}</div>
        <div style="color:var(--dim);font-size:14px;margin-bottom:4px">${correctCount}/${this._questions.length} Á≠îÂØπ</div>
        <div style="color:var(--acc);font-size:16px;font-weight:700;margin:8px 0">+${xpEarned} XP</div>
        ${isNewBest?'<div style="color:var(--ok);font-size:16px;font-weight:700;margin:12px 0">üéâ Êñ∞Á∫™ÂΩïÔºÅ</div>':'<div style="color:var(--dim);font-size:13px;margin:12px 0">ÊúÄÈ´òÂàÜÔºö'+Math.max(best,this._score)+'</div>'}
        <div class="dc-streak-display">
          <span style="font-size:28px">üî•</span>
          <span style="font-size:24px;font-weight:900;color:var(--acc)">${streakData.count}</span>
          <span style="color:var(--dim);font-size:13px">Â§©ËøûÁª≠</span>
        </div>
        <div style="margin-top:24px">
          <button class="quiz-next-btn" onclick="DailyChallenge.close()">ÂÆåÊàê</button>
        </div>
      </div>`;
  },

  close(){
    document.getElementById('challengeOverlay').classList.remove('active');
    if(this._timer){clearInterval(this._timer);this._timer=null;}
    render();
  }
};
window.DailyChallenge=DailyChallenge;

/* ---- AI Score Rendering ---- */
function renderAIScore(result){
  const el=document.getElementById('scoreRing');
  if(!el)return;
  const score=result.rhythm.overall;
  const color=score>=70?'var(--ok)':score>=40?'var(--acc)':'var(--red)';
  const C=2*Math.PI*34;
  const offset=C-(score/100)*C;
  el.innerHTML=`
    <svg class="score-ring-svg" width="80" height="80" viewBox="0 0 80 80">
      <circle class="score-ring-bg" cx="40" cy="40" r="34"/>
      <circle class="score-ring-fg" cx="40" cy="40" r="34" stroke="${color}"
        stroke-dasharray="${C}" stroke-dashoffset="${C}"/>
    </svg>
    <span class="score-num" style="color:${color}">${score}</span>`;
  setTimeout(()=>{
    const fg=el.querySelector('.score-ring-fg');
    if(fg)fg.setAttribute('stroke-dashoffset',offset);
  },50);

  const detail=document.getElementById('scoreDetail');
  if(detail){
    detail.innerHTML=`
      <div class="ai-score-grid">
        <div class="ai-score-item"><label>ÈáçÈü≥</label><div class="val" style="color:${result.rhythm.stressAccuracy>=70?'var(--ok)':'var(--acc)'}">${result.rhythm.stressAccuracy||0}</div></div>
        <div class="ai-score-item"><label>ËäÇÂ•è</label><div class="val" style="color:${result.rhythm.timingRatio>=70?'var(--ok)':'var(--acc)'}">${result.rhythm.timingRatio||0}</div></div>
        <div class="ai-score-item"><label>ËØ≠Ë∞É</label><div class="val" style="color:${result.rhythm.intonation>=70?'var(--ok)':'var(--acc)'}">${result.rhythm.intonation||0}</div></div>
        <div class="ai-score-item"><label>ÊµÅÁïÖÂ∫¶</label><div class="val" style="color:${result.rhythm.connectedSpeech>=70?'var(--ok)':'var(--acc)'}">${result.rhythm.connectedSpeech||0}</div></div>
      </div>
      ${result.rhythm.feedback&&result.rhythm.feedback.length?'<div class="coach-tip" style="margin-top:8px">'+result.rhythm.feedback.join('<br>')+'</div>':''}
      ${result.sentenceErrors&&result.sentenceErrors.length?'<div style="margin-top:8px">'+result.sentenceErrors.slice(0,4).map(e=>'<span class="phoneme-tip" style="white-space:pre-line">'+e.tipCn+'</span>').join(' ')+'</div>':''}
    `;
  }

  // Draw pitch contour if available
  if(result.prosody && result.prosody.overlay){
    drawPitchContour(result.prosody.overlay);
  }
}

function drawPitchContour(overlay){
  const canvas=document.getElementById('pitchCanvas');
  if(!canvas||!overlay)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=canvas.offsetWidth*dpr;
  const H=canvas.offsetHeight*dpr;
  canvas.width=W;canvas.height=H;
  ctx.clearRect(0,0,W,H);

  const ref=overlay.reference||[];
  const usr=overlay.user||[];
  if(!ref.length&&!usr.length)return;

  // Find frequency range
  const allFreqs=[...ref,...usr].filter(f=>f>0);
  if(!allFreqs.length)return;
  const minF=Math.min(...allFreqs)*0.9;
  const maxF=Math.max(...allFreqs)*1.1;
  const range=maxF-minF||1;

  function drawLine(data,color,lineWidth){
    ctx.beginPath();
    ctx.strokeStyle=color;
    ctx.lineWidth=lineWidth*dpr;
    ctx.lineJoin='round';
    let started=false;
    for(let i=0;i<data.length;i++){
      if(data[i]<=0){started=false;continue;}
      const x=(i/data.length)*W;
      const y=H-(data[i]-minF)/range*H;
      if(!started){ctx.moveTo(x,y);started=true;}
      else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  drawLine(ref,'rgba(99,102,241,0.7)',2);
  drawLine(usr,'rgba(52,211,153,0.9)',2);
}

/* ---- Shadowing Mode ---- */
const ShadowMode={
  _script:null, _sentenceData:null,

  start(){
    const s=getSentences()[idx];
    if(!s)return;
    this._sentenceData=s;
    this._plan=ShadowingScript.createPlan(s);
    this._currentStep=0;
    document.getElementById('shadowOverlay').classList.add('active');
    this.render();
  },

  render(){
    if(!this._plan)return;
    const steps=this._plan.steps;
    const chunks=this._plan.chunks||[];
    let html='';
    html+=`<div class="sentence" style="margin-bottom:16px;font-size:18px">${this._sentenceData.text}</div>`;
    html+=`<div class="ipa" style="margin-bottom:16px">${this._sentenceData.ipa}</div>`;

    steps.forEach((step,i)=>{
      const isCurrent=i===this._currentStep;
      const isDone=i<this._currentStep;
      const showChunks=isCurrent&&i===1&&chunks.length;
      html+=`<div class="shadow-step${isCurrent?' current':''}${isDone?' done':''}">
        <div class="shadow-step-num">Á¨¨ ${step.step} Ê≠•</div>
        <div class="shadow-step-title">${step.name}</div>
        <div class="shadow-step-desc">${step.instruction}</div>
        ${step.actions?'<ul style="margin:8px 0;padding-left:20px;font-size:12px;color:var(--dim)">'+step.actions.map(a=>'<li style="margin:4px 0">'+a+'</li>').join('')+'</ul>':''}
        ${showChunks?'<div class="shadow-chunks">'+chunks.map((c,j)=>
          '<button class="shadow-chunk" onclick="ShadowMode.playChunk('+j+')">'+c.stressMarked+'</button>'
        ).join('')+'</div>':''}
        ${isCurrent?'<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">'+
          '<button class="audio-btn primary" onclick="ShadowMode.listen('+i+')">Âê¨‰∏ÄÂê¨</button>'+
          (i>=2?'<button class="audio-btn rec-btn" onclick="ShadowMode.record()">ÂΩïÈü≥</button>':'')+
          '<button class="audio-btn" style="background:var(--acc)" onclick="ShadowMode.next()">‰∏ã‰∏ÄÊ≠•</button>'+
        '</div>':''}
      </div>`;
    });

    document.getElementById('shadowContent').innerHTML=html;
  },

  listen(stepIdx){
    const s=this._sentenceData;
    if(!s)return;
    playAudio(stepIdx===0?0.7:1);
  },

  playChunk(chunkIdx){
    if(typeof speechSynthesis==='undefined')return;
    const chunk=this._plan?.chunks?.[chunkIdx];
    if(!chunk)return;
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(chunk.text);
    u.lang='en-US';u.rate=0.75;
    speechSynthesis.speak(u);
  },

  async record(){
    await startRecording();
  },

  next(){
    if(!this._plan)return;
    this._currentStep=Math.min(this._currentStep+1, this._plan.steps.length-1);
    this.render();
  },

  close(){
    document.getElementById('shadowOverlay').classList.remove('active');
    if(isRecording)stopRecording();
  }
};
window.ShadowMode=ShadowMode;

/* ---- AI Coach Panel ---- */
const CoachPanel={
  _open:false,

  toggle(){
    this._open=!this._open;
    document.getElementById('coachPanel').classList.toggle('open',this._open);
    if(this._open)this.render();
  },

  render(){
    const el=document.getElementById('coachContent');
    if(!el)return;

    let html='';

    // Weakness report
    try{
      const report=weaknessProfiler.generateReport();
      if(report&&report.topWeaknesses&&report.topWeaknesses.length){
        html+='<div class="coach-section"><h3>ËñÑÂº±ÁéØËäÇ</h3>';
        const catNames={stress:'ÈáçÈü≥',intonation:'ËØ≠Ë∞É',linking:'ËøûËØª',speed:'ËäÇÂ•è',vowels:'ÂÖÉÈü≥',consonants:'ËæÖÈü≥'};
        report.topWeaknesses.forEach(w=>{
          const score=Math.round((w.score||0)*100);
          const color=score>=70?'var(--ok)':score>=40?'var(--acc)':'var(--red)';
          html+=`<div style="margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;font-size:13px"><span>${catNames[w.category]||w.category}</span><span style="color:${color};font-weight:700">${score}/100</span></div>
            <div class="weakness-bar"><div class="weakness-fill" style="width:${score}%;background:${color}"></div></div>
            <div style="font-size:11px;color:var(--dim)">${w.description||''}</div>
          </div>`;
        });
        html+='</div>';
        if(report.overallLevel){
          const levelNames={beginner:'ÂàùÁ∫ß',intermediate:'‰∏≠Á∫ß',advanced:'È´òÁ∫ß'};
          html+=`<div class="coach-section"><h3>ÊÄª‰ΩìÊ∞¥Âπ≥</h3><div class="coach-tip" style="font-size:16px;font-weight:700;text-align:center">${levelNames[report.overallLevel]||report.overallLevel}</div></div>`;
        }
      }
    }catch(e){console.warn('Report gen:',e);}

    // AI coaching tips
    if(aiEngine){
      try{
        const stats=aiEngine.adaptiveCoach?.getStats?.() || {};
        html+='<div class="coach-section"><h3>ÁªÉ‰π†ÁªüËÆ°</h3>';
        html+=`<div class="coach-stat"><span>ÊÄªÂΩïÈü≥Êï∞</span><span class="coach-stat-val">${stats.totalRecordings||stats.total||0}</span></div>`;
        html+=`<div class="coach-stat"><span>Âπ≥ÂùáÂàÜ</span><span class="coach-stat-val">${Math.round(stats.averageScore||stats.avgScore||0)}</span></div>`;
        html+=`<div class="coach-stat"><span>Á≠âÁ∫ß</span><span class="coach-stat-val">${stats.level||'Beginner'}</span></div>`;
        html+=`<div class="coach-stat"><span>ÊúÄÈ´òÂàÜ</span><span class="coach-stat-val">${stats.bestScore||stats.best||0}</span></div>`;
        html+='</div>';
      }catch(e){}

      const level=aiEngine.adaptiveCoach?.getDifficultyLevel?.() || 'beginner';
      const tips={
        beginner:'ÈáçÁÇπÁªÉ‰π†Ê≠£Á°ÆÁöÑÈáçÈü≥‰ΩçÁΩÆ„ÄÇ‰ªîÁªÜÂê¨ÔºåÁÑ∂ÂêéÂ§∏Âº†Âú∞ËØªÈáçÈü≥Èü≥ËäÇ„ÄÇ',
        intermediate:'ÁªÉ‰π†ÂçïËØç‰πãÈó¥ÁöÑËøûËØª„ÄÇÂ∞ùËØïË∑üËØªÊ®°ÂºèÊù•Ê®°‰ªøÂú∞ÈÅìËäÇÂ•è„ÄÇ',
        advanced:'ÂæÆË∞ÉËØ≠Ë∞ÉÊõ≤Á∫ø„ÄÇÊ≥®ÊÑè‰∏çÂêåÂè•Âûã‰∏≠Â£∞Ë∞ÉÁöÑÂçáÈôçÂèòÂåñ„ÄÇ'
      };
      html+=`<div class="coach-section"><h3>ÊïôÁªÉÂª∫ËÆÆ</h3><div class="coach-tip">${tips[level]||tips.beginner}</div></div>`;
    }

    // Connected speech rules for current sentence
    const s=getSentences()[idx];
    if(s){
      const rules=speechRules.analyze(s.text);
      if(rules&&rules.length){
        html+='<div class="coach-section"><h3>ËøûËØªËßÑÂàô</h3>';
        rules.slice(0,3).forEach(r=>{
          html+=`<div class="coach-tip"><strong>${r.rule.name}</strong>: ${r.example.written} ‚Üí ${r.example.spoken}<br><span style="color:var(--dim);font-size:11px">${r.rule.description}</span></div>`;
        });
        html+='</div>';
      }

      // Intonation suggestion
      const intonation=intonationPatterns.suggest(s.text);
      if(intonation){
        html+=`<div class="coach-section"><h3>ËØ≠Ë∞É</h3><div class="coach-tip"><strong>${intonation.name}</strong><br>${intonation.description||''}<br><span style="color:var(--dim);font-size:11px">${intonation.chineseComparison||''}</span></div></div>`;
      }
    }

    el.innerHTML=html||'<div style="text-align:center;color:var(--dim);padding:40px 0">ÂΩïÂá†‰∏™Âè•Â≠êÊù•Êü•ÁúãAIÊïôÁªÉÂàÜÊûêÔºÅ</div>';
  }
};
window.CoachPanel=CoachPanel;

/* ---- Init ---- */
updateXP();
render();
if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
