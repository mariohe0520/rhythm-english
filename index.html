<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Rhythm English</title>
<link rel="manifest" href="manifest.json">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#14141f;--pri:#6366f1;--acc:#f59e0b;--ok:#10b981;--txt:#f1f5f9;--dim:#64748b;--red:#ef4444;--r:16px}
html,body{height:100%;background:var(--bg);color:var(--txt);font-family:-apple-system,system-ui,sans-serif;-webkit-user-select:none;user-select:none;overflow-x:hidden}
.app{display:flex;flex-direction:column;min-height:100%;padding:env(safe-area-inset-top) 16px calc(env(safe-area-inset-bottom) + 80px)}
/* Header ‚Äî sticky */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 0;position:sticky;top:0;background:var(--bg);z-index:10}
.hdr h1{font-size:18px;font-weight:700}
.hdr-right{display:flex;align-items:center;gap:8px}
.badge{background:var(--pri);padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.mode-toggle{display:flex;align-items:center;gap:6px}
.mode-toggle label{font-size:11px;color:var(--dim)}
.toggle{position:relative;width:36px;height:20px;background:#1e1e2e;border-radius:10px;cursor:pointer;transition:background .2s;flex-shrink:0}
.toggle.on{background:var(--pri)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:white;border-radius:50%;transition:left .2s}
.toggle.on::after{left:18px}
/* Progress */
.progress-bar{height:3px;background:#1e1e2e;border-radius:2px;margin-bottom:12px;position:sticky;top:46px;z-index:10}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--pri),var(--acc));border-radius:2px;transition:width .3s}
/* Scene card ‚Äî the big visual */
.scene-card{border-radius:16px;padding:24px 20px;text-align:center;margin-bottom:16px;position:relative;overflow:hidden;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.scene-card::after{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(255,255,255,.08) 0%,transparent 70%);pointer-events:none}
.scene-icon{font-size:40px;margin-bottom:6px;filter:drop-shadow(0 2px 8px rgba(0,0,0,0.3))}
.scene-title{font-size:24px;font-weight:900;color:white;letter-spacing:2px;text-shadow:0 2px 8px rgba(0,0,0,.3)}
.scene-sub{font-size:13px;color:rgba(255,255,255,.85);margin-top:4px;font-weight:500}
/* Category tag */
.cat{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;text-align:center}
/* Chinese helper ‚Äî always visible in CN mode */
.cn-helper{font-size:14px;color:var(--acc);background:rgba(245,158,11,0.08);padding:10px 14px;border-radius:10px;margin-bottom:14px;text-align:center;border:1px solid rgba(245,158,11,0.15);line-height:1.5}
/* Stress visualization ‚Äî the core visual */
.stress-row{display:flex;gap:4px;justify-content:center;align-items:flex-end;margin-bottom:16px;min-height:70px;flex-wrap:wrap;padding:8px 0}
.stress-word{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:28px}
.stress-dot{border-radius:50%;transition:all .3s}
.stress-dot.big{background:var(--acc);box-shadow:0 0 8px rgba(245,158,11,0.4)}
.stress-dot.small{background:var(--pri);opacity:.4}
.stress-label{font-size:11px;color:var(--dim);line-height:1.2}
.stress-label.loud{color:var(--acc);font-weight:800;font-size:12px}
/* Sentence */
.sentence{font-size:22px;font-weight:700;text-align:center;line-height:1.4;margin-bottom:4px}
.ipa{font-size:12px;color:var(--dim);text-align:center;margin-bottom:16px;font-family:'Courier New',monospace;opacity:.7}
/* Audio buttons */
.audio-row{display:flex;gap:10px;justify-content:center;margin-bottom:18px}
.audio-btn{border:none;color:white;padding:10px 22px;border-radius:24px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;transition:transform .1s;box-shadow:0 2px 8px rgba(0,0,0,.2)}
.audio-btn:active{transform:scale(.93)}
.audio-btn.primary{background:var(--pri)}
.audio-btn.slow{background:var(--ok)}
.audio-btn.playing{animation:audioPulse 1s ease infinite}
@keyframes audioPulse{0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,.4)}50%{box-shadow:0 0 0 8px rgba(99,102,241,0)}}
/* Sections */
.section{margin-bottom:14px}
.section-label{font-size:10px;color:var(--acc);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px;font-weight:700}
.section-text{font-size:14px;line-height:1.6;color:var(--txt)}
.trap{color:#f87171;font-style:italic;font-size:13px;padding:6px 10px;background:rgba(248,113,113,0.06);border-radius:8px;border-left:3px solid #f87171}
.tip{color:var(--ok);font-size:13px;padding:6px 10px;background:rgba(16,185,129,0.06);border-radius:8px;border-left:3px solid var(--ok)}
/* Variants */
.variants{display:flex;flex-direction:column;gap:6px}
.variant{background:#1a1a2e;padding:8px 12px;border-radius:8px;font-size:13px;border-left:3px solid var(--pri);line-height:1.4}
/* Pattern */
.pattern{background:rgba(99,102,241,0.12);color:var(--pri);padding:6px 12px;border-radius:8px;font-size:13px;font-family:'Courier New',monospace;display:inline-block;border:1px solid rgba(99,102,241,0.2)}
/* Chinese reveal */
.cn-reveal{text-align:center;margin-top:12px;padding:12px 0}
.cn-btn{background:none;border:1px dashed var(--dim);color:var(--dim);padding:8px 20px;border-radius:20px;font-size:12px;cursor:pointer;transition:all .2s}
.cn-btn:active{background:var(--dim);color:var(--bg)}
.cn-text{font-size:14px;color:var(--dim);display:none;margin-top:8px}
.cn-text.show{display:block}
/* Nav ‚Äî fixed bottom */
.nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-between;align-items:center;padding:12px 24px calc(env(safe-area-inset-bottom,8px) + 8px);background:linear-gradient(transparent,var(--bg) 20%);z-index:20}
.nav-btn{background:var(--card);border:none;color:var(--txt);width:48px;height:48px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.nav-btn:active{background:var(--pri);transform:scale(.9)}
.nav-btn:disabled{opacity:.15}
.nav-count{font-size:13px;color:var(--dim)}
/* Card animation */
.card{background:var(--card);border-radius:var(--r);padding:24px 20px;width:100%;max-width:400px;margin:0 auto;transition:transform .25s ease,opacity .25s ease}
.card.slide-l{transform:translateX(-110%);opacity:0}
.card.slide-r{transform:translateX(110%);opacity:0}
/* Streak bar */
.streak-bar{display:flex;align-items:center;gap:8px;background:var(--card);border-radius:10px;padding:10px 14px;margin-bottom:12px}
.streak-fire{font-size:22px}
.streak-num{font-size:18px;font-weight:900;color:var(--acc)}
.streak-label{font-size:11px;color:var(--dim)}
.streak-dots{display:flex;gap:4px;margin-left:auto}
.streak-d{width:8px;height:8px;border-radius:50%;background:#1e1e2e}
.streak-d.done{background:var(--acc)}
.streak-d.today{background:var(--acc);box-shadow:0 0 6px rgba(245,158,11,.5)}
/* Learned button */
.learn-btn{width:100%;border:none;padding:14px;border-radius:12px;font-size:15px;font-weight:700;cursor:pointer;margin-top:16px;transition:all .2s}
.learn-btn.unlearned{background:#1e1e2e;color:var(--dim)}
.learn-btn.learned{background:rgba(16,185,129,.15);color:var(--ok)}
.learn-btn:active{transform:scale(.97)}
/* Completion summary */
.complete-summary{text-align:center;padding:8px 0;font-size:12px;color:var(--dim)}
.complete-summary b{color:var(--ok)}
/* Quiz mode */
.quiz-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg);z-index:100;display:none;flex-direction:column;padding:env(safe-area-inset-top) 20px 20px;overflow-y:auto}
.quiz-overlay.active{display:flex}
.quiz-progress{display:flex;gap:3px;margin-bottom:20px}
.quiz-pip{flex:1;height:4px;border-radius:2px;background:#1e1e2e}
.quiz-pip.done{background:var(--ok)}
.quiz-pip.wrong{background:var(--red)}
.quiz-pip.current{background:var(--acc)}
.quiz-q{font-size:18px;font-weight:700;text-align:center;margin:20px 0 12px;line-height:1.4}
.quiz-hint{font-size:13px;color:var(--dim);text-align:center;margin-bottom:20px}
.quiz-opts{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.quiz-opt{padding:16px;border-radius:12px;background:var(--card);border:2px solid transparent;font-size:15px;color:var(--txt);cursor:pointer;text-align:left;transition:all .15s;line-height:1.4}
.quiz-opt:active{transform:scale(.97)}
.quiz-opt.selected{border-color:var(--acc);background:rgba(99,102,241,.1)}
.quiz-opt.correct{border-color:var(--ok);background:rgba(16,185,129,.1)}
.quiz-opt.wrong{border-color:var(--red);background:rgba(239,68,68,.1)}
.quiz-feedback{text-align:center;padding:16px;border-radius:12px;margin-bottom:16px;font-size:14px;font-weight:600}
.quiz-feedback.right{background:rgba(16,185,129,.1);color:var(--ok)}
.quiz-feedback.wrong{background:rgba(239,68,68,.1);color:var(--red)}
.quiz-next-btn{width:100%;padding:16px;border-radius:12px;border:none;font-size:16px;font-weight:700;cursor:pointer;background:var(--pri);color:white;margin-top:auto}
.quiz-next-btn:active{transform:scale(.97)}
.quiz-score{text-align:center;margin:40px 0}
.quiz-score-num{font-size:64px;font-weight:900;color:var(--ok)}
.quiz-score-label{font-size:16px;color:var(--dim);margin-top:4px}
.quiz-xp{font-size:24px;font-weight:800;color:var(--acc);margin-top:12px}
/* Quiz trigger button */
.quiz-trigger{width:100%;padding:14px;border-radius:12px;border:2px dashed var(--acc);background:transparent;color:var(--acc);font-size:15px;font-weight:700;cursor:pointer;margin-top:12px;transition:all .2s}
.quiz-trigger:active{background:rgba(99,102,241,.1);transform:scale(.97)}
/* XP display */
.xp-display{display:flex;align-items:center;gap:4px}
.xp-num{font-size:13px;font-weight:800;color:var(--acc)}
/* Rhythm bouncing ball */
.rhythm-ball{position:absolute;width:12px;height:12px;background:var(--acc);border-radius:50%;box-shadow:0 0 12px rgba(245,158,11,.6);transition:left .15s ease-out;z-index:5;pointer-events:none}
.rhythm-ball.big{width:18px;height:18px;background:#f59e0b;box-shadow:0 0 20px rgba(245,158,11,.8)}
@keyframes ballBounce{0%{transform:translateY(0)}40%{transform:translateY(-22px)}100%{transform:translateY(0)}}
@keyframes ballBounceBig{0%{transform:translateY(0) scale(1)}30%{transform:translateY(-36px) scale(1.4)}100%{transform:translateY(0) scale(1)}}
.stress-word.active{transform:scale(1.15);transition:transform .15s}
.stress-word.active .stress-label{color:var(--acc)!important;font-weight:900!important}
.stress-word.active .stress-dot{box-shadow:0 0 14px rgba(245,158,11,.7)!important}
/* Day Switcher */
.day-switcher{display:flex;gap:8px;margin-bottom:12px}
.day-pill{flex:1;padding:12px 10px;border-radius:12px;border:2px solid #1e1e2e;background:var(--card);color:var(--dim);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:3px;transition:all .2s}
.day-pill.active{border-color:var(--pri);background:rgba(99,102,241,.15);color:var(--txt)}
.day-pill.locked{opacity:.45;cursor:not-allowed}
.day-pill.locked:active{transform:none}
.day-pill:active{transform:scale(.97)}
.day-pill-label{font-size:13px;font-weight:800;letter-spacing:.5px}
.day-pill-sub{font-size:10px;opacity:.7}
.day-pill-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:#1e1e2e;margin-top:2px}
.day-pill.active .day-pill-badge{background:var(--pri);color:white}
/* Day Overview */
.day-overview{display:flex;justify-content:center;gap:12px;margin-bottom:10px;font-size:11px;color:var(--dim)}
.day-ov-badge{padding:3px 10px;border-radius:8px;background:var(--card);display:inline-flex;align-items:center;gap:4px}
.day-ov-badge.active{color:var(--pri);font-weight:700;border:1px solid rgba(99,102,241,.3)}
.day-ov-badge.locked{opacity:.5}
/* Recording & Comparison */
.audio-row{flex-wrap:wrap}
.rec-btn{background:var(--card)!important;border:2px solid var(--dim)}
.rec-btn.recording{background:var(--red)!important;border-color:var(--red)!important;animation:recPulse 1s ease infinite}
@keyframes recPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.5)}50%{box-shadow:0 0 0 12px rgba(239,68,68,0)}}
.rec-timer{font-size:11px;color:var(--red);font-weight:700;font-variant-numeric:tabular-nums}
.compare-area{background:var(--card);border-radius:14px;padding:16px;margin-bottom:18px;border:1px solid #1e1e2e}
.compare-label{font-size:10px;color:var(--acc);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;font-weight:700;text-align:center}
.compare-btns{display:flex;gap:10px;justify-content:center;margin-bottom:14px}
.compare-btn{border:none;color:white;padding:10px 18px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;transition:transform .1s;box-shadow:0 2px 6px rgba(0,0,0,.2)}
.compare-btn:active{transform:scale(.93)}
.compare-btn.native{background:var(--pri)}
.compare-btn.user{background:var(--ok)}
.compare-btn.cplaying{animation:audioPulse 1s ease infinite}
.waveform-wrap{display:flex;gap:8px;margin-bottom:14px}
.waveform-box{flex:1;text-align:center}
.waveform-box label{font-size:10px;color:var(--dim);display:block;margin-bottom:4px}
.waveform-canvas{width:100%;height:50px;border-radius:8px;background:#0a0a0f;display:block}
.score-wrap{display:flex;flex-direction:column;align-items:center;margin:12px 0 4px}
.score-ring-container{position:relative;width:80px;height:80px}
.score-ring-svg{transform:rotate(-90deg)}
.score-ring-bg{fill:none;stroke:#1e1e2e;stroke-width:6}
.score-ring-fg{fill:none;stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset .8s ease,stroke .3s}
.score-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:22px;font-weight:900}
.score-label{font-size:11px;color:var(--dim);margin-top:6px}
.score-detail{font-size:11px;color:var(--dim);margin-top:4px;text-align:center}
.rec-history{margin-top:12px;padding-top:12px;border-top:1px solid #1e1e2e}
.rec-history-label{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;text-align:center}
.rec-history-list{display:flex;gap:8px;justify-content:center}
.rec-hist-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:8px 12px;border-radius:10px;background:#0a0a0f;transition:all .15s;min-width:56px}
.rec-hist-item:active{background:#1e1e2e;transform:scale(.95)}
.rec-hist-item.active{border:1px solid var(--ok)}
.rec-hist-score{font-size:14px;font-weight:800}
.rec-hist-time{font-size:9px;color:var(--dim)}
.rec-hist-play{font-size:16px;margin-top:2px}
</style>
</head>
<body>
<div class="app">
  <div class="hdr">
    <h1>üéµ Rhythm English</h1>
    <div class="hdr-right">
      <div class="mode-toggle">
        <label>‰∏≠Êñá</label>
        <div class="toggle" id="cnToggle" onclick="toggleCN()"></div>
      </div>
      <div class="xp-display">‚ö°<span class="xp-num" id="xpNum">0</span></div>
      <div class="badge" id="dayBadge">Day 1</div>
    </div>
  </div>
  <div class="streak-bar" id="streakBar"></div>
  <div class="progress-bar"><div class="progress-fill" id="prog"></div></div>
  <div class="complete-summary" id="completeSummary"></div>
  <div class="day-switcher" id="daySwitcher"></div>
  <div class="day-overview" id="dayOverview"></div>
  <div class="card" id="card"></div>
</div>
<!-- Quiz overlay -->
<div class="quiz-overlay" id="quizOverlay">
  <div class="quiz-progress" id="quizProgress"></div>
  <div id="quizContent"></div>
</div>

<div class="nav">
  <button class="nav-btn" id="prev" onclick="go(-1)">‚Üê</button>
  <span class="nav-count" id="count"></span>
  <button class="nav-btn" id="next" onclick="go(1)">‚Üí</button>
</div>
<script type="module">
import{DAY1,SCENES}from'./data/sentences.js';
import{DAY2,SCENES_DAY2}from'./data/day2.js';

/* ---- Day Management ---- */
let currentDay=parseInt(localStorage.getItem('re-currentDay')||'1');
function getSentences(){return currentDay===1?DAY1:DAY2;}
function getScenes(){return currentDay===1?SCENES:SCENES_DAY2;}

/* ---- Migrate old single-day progress (one-time) ---- */
(function(){
  const old=localStorage.getItem('re-progress');
  if(old){localStorage.setItem('re-progress-day1',old);localStorage.removeItem('re-progress');}
  const oi=localStorage.getItem('re-idx');
  if(oi!==null){localStorage.setItem('re-idx-day1',oi);localStorage.removeItem('re-idx');}
})();

let idx=parseInt(localStorage.getItem(`re-idx-day${currentDay}`)||'0');
let cnMode=localStorage.getItem('re-cn')==='1';
const $=s=>document.querySelector(s);
let audio=null;

/* ---- Recording State ---- */
let mediaRecorder=null,isRecording=false,recChunks=[],recBlob=null,recUrl=null;
let recSentenceId=null,recScore=null,recTimerId=null,recStartTime=0;
let audioCtx=null;
function getAudioCtx(){
  if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended')audioCtx.resume();
  return audioCtx;
}
function getRecHistory(sid){return JSON.parse(localStorage.getItem(`re-rec-${sid}`)||'[]');}

/* ---- Progress (per-day) ---- */
function getProgress(day){
  const d=day||currentDay;
  return JSON.parse(localStorage.getItem(`re-progress-day${d}`)||'{"learned":[],"streak":0,"lastDate":null,"history":[],"quizBest":0}');
}
function saveProgress(p,day){
  const d=day||currentDay;
  localStorage.setItem(`re-progress-day${d}`,JSON.stringify(p));
}
function todayStr(){return new Date().toISOString().slice(0,10);}

/* ---- Day 2 Unlock (Day 1 quiz >= 60%) ---- */
function isDay2Unlocked(){return getProgress(1).quizBest>=60;}

/* Guard: if on Day 2 but locked, reset to Day 1 */
if(currentDay===2&&!isDay2Unlocked()){currentDay=1;localStorage.setItem('re-currentDay','1');idx=parseInt(localStorage.getItem('re-idx-day1')||'0');}

/* ---- Switch Day ---- */
window.switchDay=function(day){
  if(day===2&&!isDay2Unlocked())return;
  localStorage.setItem(`re-idx-day${currentDay}`,String(idx));
  currentDay=day;
  localStorage.setItem('re-currentDay',String(day));
  idx=parseInt(localStorage.getItem(`re-idx-day${currentDay}`)||'0');
  const len=getSentences().length;
  if(idx>=len)idx=len-1;
  if(idx<0)idx=0;
  renderDaySwitcher();
  render();
};

/* ---- Render Day Switcher & Overview ---- */
function renderDaySwitcher(){
  const p1=getProgress(1),p2=getProgress(2);
  const unlocked2=isDay2Unlocked();
  const pct1=DAY1.length?Math.round(p1.learned.length/DAY1.length*100):0;
  const pct2=DAY2.length?Math.round(p2.learned.length/DAY2.length*100):0;
  const badge1=p1.quizBest>0?`‚úÖ ${p1.quizBest}%`:`${pct1}%`;
  const badge2=unlocked2?(p2.quizBest>0?`‚úÖ ${p2.quizBest}%`:'üÜï NEW'):'üîí LOCKED';
  $('#daySwitcher').innerHTML=`
    <button class="day-pill${currentDay===1?' active':''}" onclick="switchDay(1)">
      <span class="day-pill-label">Day 1</span>
      <span class="day-pill-sub">Business Meeting</span>
      <span class="day-pill-badge">${badge1}</span>
    </button>
    <button class="day-pill${currentDay===2?' active':''}${!unlocked2?' locked':''}" onclick="switchDay(2)">
      <span class="day-pill-label">Day 2</span>
      <span class="day-pill-sub">Negotiations</span>
      <span class="day-pill-badge">${badge2}</span>
    </button>`;
  $('#dayOverview').innerHTML=`
    <span class="day-ov-badge${currentDay===1?' active':''}">Day 1 ${p1.quizBest>=60?'‚úÖ':pct1>0?'üìñ':''} ${pct1}%</span>
    <span class="day-ov-badge${currentDay===2?' active':''}${!unlocked2?' locked':''}">Day 2 ${unlocked2?(p2.quizBest>=60?'‚úÖ':'üÜï'):'üîí'} ${unlocked2?pct2+'%':'NEW'}</span>`;
  $('#dayBadge').textContent=`Day ${currentDay}`;
}

/* ---- Toggle Learned ---- */
window.toggleLearned=function(){
  const sents=getSentences();
  const p=getProgress();
  const sid=sents[idx].id;
  const i=p.learned.indexOf(sid);
  if(i>=0)p.learned.splice(i,1);else p.learned.push(sid);
  const today=todayStr();
  if(p.lastDate!==today){
    if(p.lastDate){const d=new Date(p.lastDate);d.setDate(d.getDate()+1);if(d.toISOString().slice(0,10)===today)p.streak++;else p.streak=1;}else p.streak=1;
    p.lastDate=today;
    if(!p.history.includes(today))p.history.push(today);
  }
  saveProgress(p);
  render();
};

/* ---- Streak ---- */
function renderStreak(){
  const p=getProgress();
  const sents=getSentences();
  const streak=p.streak||0;
  const today=todayStr();
  const dots=[];
  for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const ds=d.toISOString().slice(0,10);const done=p.history&&p.history.includes(ds);const isToday=ds===today;dots.push(`<div class="streak-d${done?' done':''}${isToday?' today':''}"></div>`);}
  $('#streakBar').innerHTML=`
    <span class="streak-fire">üî•</span>
    <span class="streak-num">${streak}</span>
    <span class="streak-label">day streak</span>
    <div class="streak-dots">${dots.join('')}</div>`;
  $('#completeSummary').innerHTML=`<b>${p.learned.length}</b>/${sents.length} sentences learned ¬∑ Day ${currentDay}`;
}

/* ---- CN Toggle ---- */
window.toggleCN=function(){
  cnMode=!cnMode;
  localStorage.setItem('re-cn',cnMode?'1':'0');
  $('#cnToggle').classList.toggle('on',cnMode);
  render();
};

/* ---- Main Render ---- */
function render(){
  if(isRecording)stopRecording();
  const sents=getSentences();
  const scenes=getScenes();
  const s=sents[idx];
  if(!s)return;
  const sc=scenes[s.id]||{icon:"üí¨",colors:["#6366f1","#818cf8"],title:"",sub:""};
  const p=getProgress();
  $('#cnToggle').classList.toggle('on',cnMode);
  $('#prog').style.width=((idx+1)/sents.length*100)+'%';
  $('#count').textContent=`${idx+1} / ${sents.length}`;
  $('#prev').disabled=idx===0;
  $('#next').disabled=idx===sents.length-1;
  const dots=s.words.map((w,i)=>{
    const stressed=s.stress[i]>=0.8;
    const mid=s.stress[i]>=0.4&&s.stress[i]<0.8;
    const size=stressed?36:mid?22:14;
    const cls=stressed?'big':'small';
    const lblCls=stressed?'loud':'';
    return`<div class="stress-word"><div class="stress-dot ${cls}" style="width:${size}px;height:${size}px"></div><span class="stress-label ${lblCls}">${stressed?w.toUpperCase():w}</span></div>`;
  }).join('');
  const cnHelper=cnMode?`<div class="cn-helper">üí° ${s.cn}</div>`:'';
  $('#card').innerHTML=`
    <div class="cat">${s.cat} ¬∑ ${idx+1}/${sents.length}</div>
    <div class="scene-card" style="background:linear-gradient(135deg,${sc.colors[0]},${sc.colors[1]})">
      <div class="scene-icon">${sc.icon}</div>
      <div class="scene-title">${sc.title}</div>
      <div class="scene-sub">${sc.sub}</div>
    </div>
    ${cnHelper}
    <div class="stress-row">${dots}</div>
    <div class="sentence">${s.text}</div>
    <div class="ipa">${s.ipa}</div>
    <div class="audio-row">
      <button class="audio-btn primary" id="playBtn" onclick="window.speak()">üîä Listen</button>
      <button class="audio-btn slow" onclick="window.speakSlow()">üê¢ Slow</button>
      <button class="audio-btn" style="background:#f59e0b" onclick="window.rhythmPlay()">üéµ Rhythm</button>
      <button class="audio-btn rec-btn" id="recBtn" onclick="window.toggleRecord()">üéôÔ∏è Record</button>
    </div>
    <div id="recCompare"></div>
    <div class="section">
      <div class="section-label">What it means</div>
      <div class="section-text">${s.meaning}</div>
    </div>
    <div class="section">
      <div class="section-label">Pattern</div>
      <div class="pattern">${s.pattern}</div>
    </div>
    <div class="section">
      <div class="section-label">Same pattern</div>
      <div class="variants">${s.variants.map(v=>`<div class="variant">${v}</div>`).join('')}</div>
    </div>
    <div class="section">
      <div class="section-label">‚ö° Rhythm tip</div>
      <div class="tip">${s.tip}</div>
    </div>
    <div class="section">
      <div class="section-label">‚ùå Non-native trap</div>
      <div class="trap">${s.trap}</div>
    </div>
    ${!cnMode?`<div class="cn-reveal">
      <button class="cn-btn" onclick="this.nextElementSibling.classList.toggle('show');this.textContent=this.textContent==='Reveal ‰∏≠Êñá'?'Hide ‰∏≠Êñá':'Reveal ‰∏≠Êñá'">Reveal ‰∏≠Êñá</button>
      <div class="cn-text">${s.cn}</div>
    </div>`:''}
    <button class="learn-btn ${p.learned.includes(s.id)?'learned':'unlearned'}" onclick="window.toggleLearned()">
      ${p.learned.includes(s.id)?'‚úÖ Learned!':'Mark as Learned'}
    </button>
    ${p.learned.length>=5?'<button class="quiz-trigger" onclick="Quiz.start()">üß† Quiz Me! ('+p.learned.length+' sentences)</button>':''}
  `;
  renderStreak();
  renderDaySwitcher();
  renderRecCompare();
  window.scrollTo({top:0,behavior:'smooth'});
  localStorage.setItem(`re-idx-day${currentDay}`,idx);
}

/* ---- Audio ---- */
function playAudio(rate=1){
  if(audio){audio.pause();audio.currentTime=0;}
  const s=getSentences()[idx];
  const id=String(s.id).padStart(2,'0');
  audio=new Audio('audio/'+id+'.mp3');
  audio.playbackRate=rate;
  const btn=document.getElementById('playBtn');
  audio.onplay=()=>{if(btn)btn.classList.add('playing');};
  audio.onended=()=>{if(btn)btn.classList.remove('playing');};
  audio.onerror=()=>{
    if(btn)btn.classList.remove('playing');
    const u=new SpeechSynthesisUtterance(s.text);
    u.lang='en-US';u.rate=rate*0.85;
    speechSynthesis.speak(u);
  };
  audio.play().catch(()=>audio.onerror());
}
window.speak=function(){playAudio(1);};
window.speakSlow=function(){playAudio(0.7);};

/* ---- Rhythm Mode (works with any day's sentences) ---- */
window.rhythmPlay=function(){
  const s=getSentences()[idx];
  if(!s)return;
  playAudio(0.85);
  const words=document.querySelectorAll('.stress-word');
  if(!words.length)return;
  const stressRow=document.querySelector('.stress-row');
  if(!stressRow)return;
  stressRow.querySelectorAll('.rhythm-ball').forEach(b=>b.remove());
  const ball=document.createElement('div');
  ball.className='rhythm-ball';
  stressRow.style.position='relative';
  stressRow.appendChild(ball);
  let elapsed=0;
  s.words.forEach((w,i)=>{
    const stressed=s.stress[i]>=0.8;
    const wordTime=stressed?280:180;
    setTimeout(()=>{
      const wordEl=words[i];
      if(!wordEl)return;
      const rect=wordEl.getBoundingClientRect();
      const parentRect=stressRow.getBoundingClientRect();
      ball.style.left=(rect.left-parentRect.left+rect.width/2-6)+'px';
      ball.style.top='-16px';
      ball.className='rhythm-ball'+(stressed?' big':'');
      ball.style.animation='none';
      void ball.offsetWidth;
      ball.style.animation=(stressed?'ballBounceBig':'ballBounce')+' '+(stressed?'0.35s':'0.25s')+' ease';
      words.forEach(w=>w.classList.remove('active'));
      wordEl.classList.add('active');
    },elapsed);
    elapsed+=wordTime;
  });
  setTimeout(()=>{ball.remove();words.forEach(w=>w.classList.remove('active'));},elapsed+500);
};

/* ---- Record & Compare ---- */
async function startRecording(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    recChunks=[];
    recSentenceId=getSentences()[idx].id;
    recScore=null;
    const mimeType=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':'audio/webm';
    mediaRecorder=new MediaRecorder(stream,{mimeType,audioBitsPerSecond:32000});
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recChunks.push(e.data);};
    mediaRecorder.onstop=async()=>{
      stream.getTracks().forEach(t=>t.stop());
      recBlob=new Blob(recChunks,{type:mimeType});
      if(recUrl)URL.revokeObjectURL(recUrl);
      recUrl=URL.createObjectURL(recBlob);
      isRecording=false;
      if(recTimerId){clearInterval(recTimerId);recTimerId=null;}
      const btn=document.getElementById('recBtn');
      if(btn){btn.classList.remove('recording');btn.innerHTML='üéôÔ∏è Record';}
      renderRecCompare();
      await analyzeAndScore();
    };
    mediaRecorder.start();
    isRecording=true;
    recStartTime=Date.now();
    const btn=document.getElementById('recBtn');
    if(btn){btn.classList.add('recording');btn.innerHTML='‚èπÔ∏è <span class="rec-timer">0.0s</span>';}
    recTimerId=setInterval(()=>{
      const el=document.querySelector('.rec-timer');
      if(el)el.textContent=((Date.now()-recStartTime)/1000).toFixed(1)+'s';
    },100);
    setTimeout(()=>{if(isRecording&&mediaRecorder&&mediaRecorder.state==='recording')stopRecording();},8000);
  }catch(e){console.error('Mic error:',e);}
}

function stopRecording(){
  if(mediaRecorder&&mediaRecorder.state==='recording')mediaRecorder.stop();
  isRecording=false;
  if(recTimerId){clearInterval(recTimerId);recTimerId=null;}
  const btn=document.getElementById('recBtn');
  if(btn){btn.classList.remove('recording');btn.innerHTML='üéôÔ∏è Record';}
}

window.toggleRecord=async function(){
  if(isRecording)stopRecording();
  else await startRecording();
};

function detectPauses(audioBuf){
  const data=audioBuf.getChannelData(0);
  const sr=audioBuf.sampleRate;
  const winSize=Math.floor(sr*0.05);
  const minSilence=Math.floor(sr*0.2);
  let silent=0,pauses=0,inSilence=false;
  for(let i=0;i<data.length;i+=winSize){
    let sum=0;const end=Math.min(i+winSize,data.length);
    for(let j=i;j<end;j++)sum+=Math.abs(data[j]);
    const avg=sum/(end-i);
    if(avg<0.015){silent+=(end-i);if(silent>=minSilence&&!inSilence){pauses++;inSilence=true;}}
    else{silent=0;inSilence=false;}
  }
  return pauses;
}

function drawWaveform(audioBuf,canvasId){
  const canvas=document.getElementById(canvasId);
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  const W=canvas.offsetWidth*dpr;
  const H=canvas.offsetHeight*dpr;
  canvas.width=W;canvas.height=H;
  ctx.clearRect(0,0,W,H);
  const data=audioBuf.getChannelData(0);
  const bars=40;
  const barW=W/bars;
  const samplesPerBar=Math.floor(data.length/bars);
  const color=canvasId==='waveNative'?'#6366f1':'#10b981';
  for(let i=0;i<bars;i++){
    let sum=0;
    for(let j=0;j<samplesPerBar;j++)sum+=Math.abs(data[i*samplesPerBar+j]||0);
    const avg=sum/samplesPerBar;
    const barH=Math.max(2,avg*H*3.5);
    const x=i*barW+1;
    const y=(H-barH)/2;
    ctx.fillStyle=color;
    ctx.beginPath();
    if(ctx.roundRect){ctx.roundRect(x,y,barW-2,barH,2);ctx.fill();}
    else ctx.fillRect(x,y,barW-2,barH);
  }
}

async function analyzeAndScore(){
  if(!recBlob)return;
  try{
    const actx=getAudioCtx();
    const userBuf=await recBlob.arrayBuffer();
    const userAudio=await actx.decodeAudioData(userBuf.slice(0));
    drawWaveform(userAudio,'waveUser');
    const s=getSentences()[idx];
    const id=String(s.id).padStart(2,'0');
    let nativeDur=s.words.length*0.3;
    let nativePauses=Math.max(0,Math.floor(s.words.length/5)-1);
    try{
      const resp=await fetch('audio/'+id+'.mp3');
      if(resp.ok){
        const natBuf=await resp.arrayBuffer();
        const natAudio=await actx.decodeAudioData(natBuf.slice(0));
        nativeDur=natAudio.duration;
        nativePauses=detectPauses(natAudio);
        drawWaveform(natAudio,'waveNative');
      }
    }catch{}
    const userDur=userAudio.duration;
    const durRatio=userDur/Math.max(nativeDur,0.5);
    const durScore=Math.max(0,60*(1-Math.abs(durRatio-1)*2));
    const userPauses=detectPauses(userAudio);
    const pauseDiff=Math.abs(userPauses-nativePauses);
    const pauseScore=Math.max(0,40-pauseDiff*12);
    const totalScore=Math.round(Math.min(100,Math.max(0,durScore+pauseScore)));
    recScore=totalScore;
    renderScoreRing(totalScore,durScore,pauseScore,userDur,nativeDur);
    saveRecording(s.id,totalScore);
  }catch(e){console.error('Analysis error:',e);}
}

function renderScoreRing(score,dS,pS,uDur,nDur){
  const el=document.getElementById('scoreRing');
  if(!el)return;
  const color=score>=70?'var(--ok)':score>=40?'var(--acc)':'var(--red)';
  const C=2*Math.PI*34;
  const offset=C-(score/100)*C;
  el.innerHTML=`
    <svg class="score-ring-svg" width="80" height="80" viewBox="0 0 80 80">
      <circle class="score-ring-bg" cx="40" cy="40" r="34"/>
      <circle class="score-ring-fg" cx="40" cy="40" r="34" stroke="${color}"
        stroke-dasharray="${C}" stroke-dashoffset="${C}"/>
    </svg>
    <span class="score-num" style="color:${color}">${score}</span>`;
  const detail=document.getElementById('scoreDetail');
  if(detail){
    const durPct=Math.round(Math.max(0,Math.min(100,dS/60*100)));
    const pPct=Math.round(Math.max(0,Math.min(100,pS/40*100)));
    detail.innerHTML=`‚è± Duration: ${uDur?uDur.toFixed(1):'?'}s vs ${nDur?nDur.toFixed(1):'?'}s (${durPct}%) ¬∑ üéµ Rhythm: ${pPct}%`;
  }
  setTimeout(()=>{
    const fg=el.querySelector('.score-ring-fg');
    if(fg)fg.setAttribute('stroke-dashoffset',offset);
  },50);
}

function saveRecording(sid,score){
  if(!recBlob)return;
  const reader=new FileReader();
  reader.onload=()=>{
    const key=`re-rec-${sid}`;
    let hist=JSON.parse(localStorage.getItem(key)||'[]');
    hist.unshift({b64:reader.result,score,ts:Date.now()});
    if(hist.length>3)hist=hist.slice(0,3);
    try{localStorage.setItem(key,JSON.stringify(hist));}
    catch(e){
      if(hist.length>1){hist=hist.slice(0,1);try{localStorage.setItem(key,JSON.stringify(hist));}catch{}}
    }
    renderRecCompare();
  };
  reader.readAsDataURL(recBlob);
}

function renderRecCompare(){
  const el=document.getElementById('recCompare');
  if(!el)return;
  const s=getSentences()[idx];
  if(!s){el.innerHTML='';return;}
  const hasRec=recBlob&&recSentenceId===s.id;
  const history=getRecHistory(s.id);
  if(!hasRec&&history.length===0){el.innerHTML='';return;}
  let html='<div class="compare-area">';
  html+='<div class="compare-label">üéôÔ∏è Record & Compare</div>';
  if(hasRec){
    html+=`<div class="compare-btns">
      <button class="compare-btn native" id="cmpNative" onclick="window.playNative()">üîä Native</button>
      <button class="compare-btn user" id="cmpUser" onclick="window.playUser()">üé§ You</button>
    </div>
    <div class="waveform-wrap">
      <div class="waveform-box"><label>Native</label><canvas class="waveform-canvas" id="waveNative"></canvas></div>
      <div class="waveform-box"><label>You</label><canvas class="waveform-canvas" id="waveUser"></canvas></div>
    </div>
    <div class="score-wrap">
      <div class="score-ring-container" id="scoreRing"></div>
      <div class="score-label">Rhythm Match</div>
      <div class="score-detail" id="scoreDetail"></div>
    </div>`;
  }
  if(history.length>0){
    html+='<div class="rec-history"><div class="rec-history-label">Recent Recordings</div><div class="rec-history-list">';
    history.forEach((h,i)=>{
      const c=h.score>=70?'var(--ok)':h.score>=40?'var(--acc)':'var(--red)';
      const t=new Date(h.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      html+=`<div class="rec-hist-item" onclick="window.playHistRec(${i})">
        <span class="rec-hist-score" style="color:${c}">${h.score}</span>
        <span class="rec-hist-play">‚ñ∂</span>
        <span class="rec-hist-time">${t}</span>
      </div>`;
    });
    html+='</div></div>';
  }
  html+='</div>';
  el.innerHTML=html;
  if(hasRec&&recScore!==null){
    renderScoreRing(recScore,0,0,0,0);
    analyzeAndScore();
  }
}

let cmpAudio=null;
window.playNative=function(){
  if(cmpAudio){cmpAudio.pause();cmpAudio=null;}
  playAudio(1);
};
window.playUser=function(){
  if(!recUrl)return;
  if(cmpAudio){cmpAudio.pause();cmpAudio=null;}
  cmpAudio=new Audio(recUrl);
  const btn=document.getElementById('cmpUser');
  if(btn)btn.classList.add('cplaying');
  cmpAudio.onended=()=>{if(btn)btn.classList.remove('cplaying');cmpAudio=null;};
  cmpAudio.play();
};
window.playHistRec=function(i){
  const s=getSentences()[idx];
  const hist=getRecHistory(s.id);
  if(!hist[i])return;
  if(cmpAudio){cmpAudio.pause();cmpAudio=null;}
  cmpAudio=new Audio(hist[i].b64);
  cmpAudio.onended=()=>{cmpAudio=null;};
  cmpAudio.play();
};

/* ---- Navigation ---- */
window.go=function(dir){
  const sents=getSentences();
  const card=$('#card');
  card.classList.add(dir>0?'slide-l':'slide-r');
  setTimeout(()=>{
    idx=Math.max(0,Math.min(sents.length-1,idx+dir));
    card.classList.remove('slide-l','slide-r');
    render();
  },200);
};
let sx=0,sy=0;
document.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;},{passive:true});
document.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-sx;
  const dy=e.changedTouches[0].clientY-sy;
  if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*1.5){dx<0?go(1):go(-1);}
},{passive:true});
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowRight')go(1);
  if(e.key==='ArrowLeft')go(-1);
  if(e.key===' '){e.preventDefault();window.speak();}
});

/* ---- XP System ---- */
function getXP(){return parseInt(localStorage.getItem('re-xp')||'0');}
function addXP(n){const x=getXP()+n;localStorage.setItem('re-xp',String(x));$('#xpNum').textContent=x;return x;}
function updateXP(){$('#xpNum').textContent=getXP();}

/* ---- Quiz Engine (per-day, saves best score) ---- */
const Quiz={
  questions:[],current:0,score:0,answered:false,results:[],

  generate(){
    const sents=getSentences();
    const p=getProgress();
    const pool=p.learned.length>=5?sents.filter(s=>p.learned.includes(s.id)):sents.slice(0,10);
    if(pool.length<4)return false;
    this.questions=[];this.current=0;this.score=0;this.results=[];
    const shuffled=[...pool].sort(()=>Math.random()-.5).slice(0,10);
    for(const s of shuffled){
      const qType=Math.random();
      if(qType<0.33){
        const wrong=pool.filter(x=>x.id!==s.id).sort(()=>Math.random()-.5).slice(0,3).map(x=>x.cn);
        const opts=[s.cn,...wrong].sort(()=>Math.random()-.5);
        this.questions.push({type:'meaning',prompt:s.text,hint:'What does this mean?',options:opts,answer:s.cn,sentenceId:s.id});
      }else if(qType<0.66){
        const wrong=pool.filter(x=>x.id!==s.id).sort(()=>Math.random()-.5).slice(0,3).map(x=>x.text);
        const opts=[s.text,...wrong].sort(()=>Math.random()-.5);
        this.questions.push({type:'scene',prompt:s.cn,hint:'Which English sentence?',options:opts,answer:s.text,sentenceId:s.id});
      }else{
        const stressedWords=s.words.filter((_,i)=>s.stress[i]>=0.8);
        if(stressedWords.length===0)continue;
        const target=stressedWords[Math.floor(Math.random()*stressedWords.length)];
        const wrong=s.words.filter(w=>w!==target&&s.stress[s.words.indexOf(w)]<0.5).slice(0,3);
        if(wrong.length<2)continue;
        const opts=[target,...wrong.slice(0,3)].sort(()=>Math.random()-.5);
        this.questions.push({type:'stress',prompt:s.text,hint:'Which word gets the STRONGEST stress?',options:opts,answer:target,sentenceId:s.id});
      }
    }
    return this.questions.length>=3;
  },

  start(){
    if(!this.generate()){alert('Learn at least 5 sentences first!');return;}
    $('#quizOverlay').classList.add('active');
    this.renderQuestion();
  },

  renderQuestion(){
    const q=this.questions[this.current];
    this.answered=false;
    $('#quizProgress').innerHTML=this.questions.map((_,i)=>{
      let cls='quiz-pip';
      if(i<this.current)cls+=this.results[i]?' done':' wrong';
      else if(i===this.current)cls+=' current';
      return`<div class="${cls}"></div>`;
    }).join('');
    $('#quizContent').innerHTML=`
      <div class="quiz-q">${q.prompt}</div>
      <div class="quiz-hint">${q.hint}</div>
      <div class="quiz-opts">${q.options.map((o,i)=>
        `<div class="quiz-opt" data-idx="${i}" onclick="Quiz.pick(${i})">${o}</div>`
      ).join('')}</div>
      <div id="quizFeedback"></div>
      <button class="quiz-next-btn" id="quizNextBtn" style="display:none" onclick="Quiz.next()">Continue</button>
    `;
  },

  pick(i){
    if(this.answered)return;
    this.answered=true;
    const q=this.questions[this.current];
    const picked=q.options[i];
    const correct=picked===q.answer;
    this.results.push(correct);
    if(correct)this.score++;
    document.querySelectorAll('.quiz-opt').forEach((el,j)=>{
      if(q.options[j]===q.answer)el.classList.add('correct');
      else if(j===i&&!correct)el.classList.add('wrong');
    });
    const fb=$('#quizFeedback');
    fb.className='quiz-feedback '+(correct?'right':'wrong');
    fb.textContent=correct?['üéâ Perfect!','‚úÖ Nailed it!','üí™ You got it!'][Math.floor(Math.random()*3)]:
      `‚ùå It's: ${q.answer}`;
    $('#quizNextBtn').style.display='block';
  },

  next(){
    this.current++;
    if(this.current>=this.questions.length){this.showResults();return;}
    this.renderQuestion();
  },

  showResults(){
    const pct=Math.round(this.score/this.questions.length*100);
    const xpEarned=this.score*10;
    addXP(xpEarned);
    // Save best quiz score for current day
    const wasDay2Unlocked=isDay2Unlocked();
    const p=getProgress();
    p.quizBest=Math.max(p.quizBest||0,pct);
    const today=todayStr();
    if(p.lastDate!==today){
      if(p.lastDate){const d=new Date(p.lastDate);d.setDate(d.getDate()+1);p.streak=d.toISOString().slice(0,10)===today?p.streak+1:1;}
      else p.streak=1;
      p.lastDate=today;
      if(!p.history.includes(today))p.history.push(today);
    }
    saveProgress(p);
    const day2JustUnlocked=currentDay===1&&!wasDay2Unlocked&&isDay2Unlocked();
    $('#quizContent').innerHTML=`
      <div class="quiz-score">
        <div class="quiz-score-num">${pct}%</div>
        <div class="quiz-score-label">${this.score}/${this.questions.length} correct</div>
        <div class="quiz-xp">+${xpEarned} XP ‚ö°</div>
      </div>
      ${day2JustUnlocked?'<div style="text-align:center;margin:16px 0;padding:16px;background:rgba(16,185,129,.1);border-radius:12px;font-size:15px;color:var(--ok);font-weight:700">üéâ Day 2: Negotiations unlocked!</div>':''}
      <button class="quiz-next-btn" onclick="Quiz.close()" style="margin-top:20px">Done</button>
    `;
    $('#quizProgress').innerHTML=this.questions.map((_,i)=>{
      return`<div class="quiz-pip${this.results[i]?' done':' wrong'}"></div>`;
    }).join('');
  },

  close(){
    $('#quizOverlay').classList.remove('active');
    render();
  }
};
window.Quiz=Quiz;

/* ---- Init ---- */
updateXP();
render();
if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js');
</script>
</body>
</html>
